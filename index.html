<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pages</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <script>/* Theme init — runs synchronously before first paint to prevent flash */
    (function(){try{var t=localStorage.getItem('pages-theme'),s=window.matchMedia('(prefers-color-scheme: dark)').matches;if(t==='dark'||(t===null&&s))document.documentElement.setAttribute('data-theme','dark');}catch(e){}})();
  </script>
  <style>
    :root {
      --bg-cream: #F2EFE9;
      --sidebar-bg: #F7F7F6;
      --sidebar-text: #1a1a1a;
      --sidebar-muted: #7a7a7a;
      --sidebar-active: rgba(0, 0, 0, 0.04);
      --editor-max: 740px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-serif: 'Lora', Georgia, serif;
      --chip-bg: rgba(0, 0, 0, 0.05);
      --chip-border: rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font);
      font-weight: 400;
      font-size: 13px;
      background: var(--bg-cream);
      color: #3a3a3a;
      min-height: 100vh;
      display: flex;
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    /* ——— Top bar (transparent, floating) ——— */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 0 24px;
      z-index: 100;
      pointer-events: none;
    }

    .top-bar-inner {
      display: flex;
      align-items: center;
      gap: 4px;
      pointer-events: auto;
    }

    .top-bar button,
    .top-bar .top-bar-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #4a4a4a;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }

    .top-bar button:hover,
    .top-bar .top-bar-btn:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .top-bar .btn-share {
      width: auto;
      padding: 6px 12px;
      gap: 6px;
      background: transparent;
      color: rgba(50, 50, 50, 0.38);
      font-size: 13px;
      font-weight: 400;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.09);
      margin-left: 4px;
      transition: background 0.12s ease-out, color 0.12s ease-out, border-color 0.12s ease-out, transform 0.06s ease-out;
    }

    .top-bar .btn-share:hover {
      background: rgba(0, 0, 0, 0.04);
      color: #3C3C3C;
      border-color: rgba(0, 0, 0, 0.15);
    }

    .top-bar .btn-share svg {
      opacity: 0.8;
    }

    /* ——— Theme pill toggle (top-right) ——— */
    .theme-pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      width: 48px;
      height: 26px;
      background: rgba(0, 0, 0, 0.07);
      border: 1px solid rgba(0, 0, 0, 0.10);
      border-radius: 100px;
      cursor: pointer;
      padding: 0;
      margin-right: 4px;
      flex-shrink: 0;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.06s ease;
    }
    .theme-pill:hover { background: rgba(0, 0, 0, 0.11); }
    .theme-pill:active { transform: scale(0.95); }
    /* Sliding thumb */
    .tp-thumb {
      position: absolute;
      top: 50%;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.18), 0 0 0 0.5px rgba(0,0,0,0.06);
      transform: translateY(-50%) translateX(0);
      transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1), background 0.15s ease;
      pointer-events: none;
    }
    /* Side icons */
    .tp-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      color: rgba(0,0,0,0.45);
      transition: color 0.15s ease;
    }
    .tp-icon svg { width: 10px; height: 10px; }
    .tp-icon-sun  { left: 5px;  }
    .tp-icon-moon { right: 5px; }
    /* Override .top-bar button defaults (width/height/bg/border/radius) */
    .top-bar .theme-pill {
      width: 48px;
      height: 26px;
      background: rgba(0, 0, 0, 0.07);
      border: 1px solid rgba(0, 0, 0, 0.10);
      border-radius: 100px;
      justify-content: flex-start;
    }
    .top-bar .theme-pill:hover { background: rgba(0, 0, 0, 0.11); }

    /* ——— Sidebar (beige) ——— */
    .sidebar {
      width: 240px;
      min-width: 240px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 16px 12px 12px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .btn-toggle-sidebar {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--sidebar-muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease-out, color 0.12s ease-out, transform 0.06s ease-out;
      flex-shrink: 0;
    }
    .btn-toggle-sidebar:hover {
      background: var(--sidebar-active);
      color: var(--sidebar-text);
    }

    /* Floating re-open button when sidebar is hidden */
    .sidebar-reveal-btn {
      position: fixed;
      left: 16px;
      top: 14px;
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255,255,255,0.85);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.10), 0 0 0 1px rgba(0,0,0,0.06);
      color: #4a4a4a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s, transform 0.06s ease-out;
      backdrop-filter: blur(4px);
    }
    body.sidebar-hidden .sidebar-reveal-btn {
      opacity: 1;
      visibility: visible;
    }

    .window-chrome {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 6px 10px;
    }

    .window-dots {
      display: flex;
      gap: 6px;
    }

    .window-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .window-dot.red { background: #ff5f57; }
    .window-dot.yellow { background: #febc2e; }
    .window-dot.green { background: #28c840; }

    .window-icon {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: rgba(255, 255, 255, 0.7);
    }

    .search-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .search-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      height: 36px;
      padding: 0 12px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 8px;
      color: var(--sidebar-muted);
      font-size: 12px;
    }

    .search-wrap svg {
      flex-shrink: 0;
      opacity: 0.5;
    }

    .search-wrap input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-size: 12px;
      color: var(--sidebar-text);
    }

    .search-wrap input::placeholder {
      color: var(--sidebar-muted);
    }

    .search-shortcut {
      font-size: 11px;
      color: var(--sidebar-muted);
    }

    .btn-new-doc-icon {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 8px;
      color: var(--sidebar-text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }

    .btn-new-note {
      width: 100%;
      padding: 7px 14px;
      margin-bottom: 12px;
      background: transparent;
      color: var(--sidebar-muted);
      border: 1px solid rgba(0, 0, 0, 0.10);
      border-radius: 8px;
      font-family: var(--font);
      font-size: 12.5px;
      font-weight: 400;
      cursor: pointer;
      transition: background 0.12s ease-out, border-color 0.12s ease-out, color 0.12s ease-out, transform 0.06s ease-out;
    }

    .btn-new-note:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.16);
      color: var(--sidebar-text);
    }

    .doc-list {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .doc-list::-webkit-scrollbar {
      width: 4px;
    }

    .doc-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .doc-list::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.12);
      border-radius: 2px;
    }

    .doc-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.12s ease-out;
      position: relative;
      margin-bottom: 2px;
      border-left: 2px solid transparent;
    }

    .doc-item:hover {
      background: var(--sidebar-active);
    }

    .doc-item.active {
      background: rgba(0, 0, 0, 0.05);
      border-left-color: transparent;
    }

    .doc-item.shake {
      animation: shake 0.35s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-4px); }
      40% { transform: translateX(4px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }

    .doc-item-icon {
      flex-shrink: 0;
      opacity: 0.6;
    }

    .doc-item-content {
      flex: 1;
      min-width: 0;
    }

    .doc-item-title {
      font-size: 12px;
      font-weight: 400;
      color: var(--sidebar-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    .doc-item-title.untitled {
      font-style: italic;
      color: var(--sidebar-muted);
    }

    .doc-item-preview {
      font-size: 11px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      margin-top: 1px;
    }

    .doc-item-preview.empty {
      font-style: italic;
      color: #bbb;
    }

    .doc-item-actions {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: opacity 0.12s ease-out;
    }

    .doc-item:hover .doc-item-actions {
      opacity: 1;
    }

    .btn-delete-doc {
      background: none;
      border: none;
      color: var(--sidebar-muted);
      cursor: pointer;
      padding: 2px 4px;
      font-size: 15px;
      line-height: 1;
      border-radius: 4px;
    }

    .btn-delete-doc:hover {
      color: #c0392b;
      background: rgba(192, 57, 43, 0.08);
    }

    /* workspace footer removed */

    /* ——— Main / document area ——— */
    .main {
      flex: 1;
      margin-left: 240px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 86px 52px 160px 24px;
      transition: margin-left 0.3s ease;
    }
    body.focus-mode .main {
      margin-left: 0;
      padding-right: 24px;
    }
    body.sidebar-hidden .sidebar {
      transform: translateX(-100%);
      pointer-events: none;
    }
    body.sidebar-hidden .main {
      margin-left: 0;
      padding-right: 24px;
    }

    .editor-wrap {
      width: 100%;
      max-width: var(--editor-max);
      position: relative;
      min-height: 420px;
    }

    .editor-title {
      font-family: var(--font-serif);
      font-size: 28px;
      font-weight: 500;
      line-height: 1.3;
      letter-spacing: -0.01em;
      color: #2C2C2C;
      border: none;
      background: transparent;
      width: 100%;
      outline: none;
      resize: none;
      overflow: hidden;
      min-height: 1.3em;
      margin-bottom: 26px;
    }

    .editor-title::placeholder {
      color: #999;
    }

    .editor-title, .editor-body {
      caret-color: #2C2C2C;
    }

    .editor-body {
      font-family: var(--font);
      font-size: 14.5px;
      font-weight: 400;
      line-height: 1.7;
      letter-spacing: -0.003em;
      color: #2C2C2C;
      border: none;
      background: transparent;
      width: 100%;
      min-height: 50vh;
      outline: none;
      overflow: visible;
    }

    .editor-body:focus {
      outline: none;
    }

    .editor-body h1 {
      font-size: 19px;
      font-weight: 600;
      color: #2C2C2C;
      margin: 32px 0 8px;
      line-height: 1.35;
      letter-spacing: -0.01em;
    }

    .editor-body h1::before {
      content: "";
      display: none;
    }

    .editor-body h2 {
      font-size: 16.5px;
      font-weight: 550;
      color: #2C2C2C;
      margin: 32px 0 6px;
      line-height: 1.4;
      letter-spacing: -0.006em;
    }

    .editor-body h3 {
      font-size: 15px;
      font-weight: 500;
      color: #2C2C2C;
      margin: 32px 0 5px;
      line-height: 1.45;
      letter-spacing: -0.004em;
    }

    .editor-body ul {
      margin: 4px 0 15px;
      padding-left: 1.6em;
      list-style-type: disc;
    }

    .editor-body ul li {
      margin: 0.2em 0;
      font-size: 14.5px;
      font-weight: 400;
      color: #2C2C2C;
    }

    .editor-body ul ul {
      list-style-type: circle;
      margin: 2px 0 2px 0.4em;
    }

    .editor-body ul ul li {
      font-size: 13.5px;
      color: #4a4a4a;
    }

    .editor-body ol {
      margin: 4px 0 15px;
      padding-left: 1.6em;
    }

    .editor-body ol li {
      margin: 0.2em 0;
      font-size: 14.5px;
      font-weight: 400;
      color: #2C2C2C;
    }

    .editor-body p {
      margin: 0 0 15px;
      font-size: 14.5px;
      font-weight: 400;
      color: #2C2C2C;
    }
    .editor-body p:last-child {
      margin-bottom: 0;
    }

    .editor-body:empty::before {
      content: attr(data-placeholder);
      color: #999;
    }

    .format-toolbar { display: none !important; }

    /* ——— Floating chat ——— */
    .floating-chat-backdrop {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: transparent;
      pointer-events: none;
    }

    .floating-chat-backdrop.visible {
      pointer-events: auto;
    }

    .floating-chat {
      position: fixed;
      /* left/top set dynamically by JS */
      width: calc(100% - 300px);
      max-width: 560px;
      min-width: 320px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.13), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 12px 16px;
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transform-origin: top center;
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
    }

    .floating-chat.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Arrow pointing toward the selection */
    .floating-chat::before {
      content: '';
      position: absolute;
      left: var(--arrow-left, 50%);
      transform: translateX(-50%);
      width: 12px;
      height: 7px;
      background: #fff;
      filter: drop-shadow(0 -1px 1px rgba(0,0,0,0.06));
      transition: left 0.1s ease;
    }

    .floating-chat.arrow-up::before {
      top: -7px;
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    }

    .floating-chat.arrow-down::before {
      top: auto;
      bottom: -7px;
      clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
    }

    .floating-chat-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-family: var(--font);
      font-size: 13.5px;
      color: var(--sidebar-text);
      padding: 4px 0;
      min-width: 0;
    }

    .floating-chat-input::placeholder {
      color: #bbb;
    }

    .floating-chat-sep {
      width: 1px;
      height: 20px;
      background: #ececec;
      margin: 0 10px;
      flex-shrink: 0;
    }

    .floating-chat-mood-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .floating-chat-mood-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: #E8EAFF;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      font-weight: 500;
      color: #6B7FD4;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }

    .floating-chat-mood-btn:hover {
      background: #dfe2fc;
    }

    .floating-chat-mood-btn svg {
      width: 10px;
      height: 10px;
      opacity: 0.8;
    }

    .floating-chat-mood-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 6px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      padding: 6px 0;
      min-width: 160px;
      display: none;
      z-index: 10;
    }

    .floating-chat-mood-dropdown.visible {
      display: block;
    }

    .floating-chat-mood-option {
      display: block;
      width: 100%;
      padding: 8px 14px;
      border: none;
      background: none;
      font-family: var(--font);
      font-size: 13px;
      color: #1a1a1a;
      text-align: left;
      cursor: pointer;
      transition: background 0.12s ease-out;
    }

    .floating-chat-mood-option:hover {
      background: #f5f5f5;
    }

    /* ——— Selection highlight while editing ——— */
    .selection-highlight {
      background: rgba(107, 127, 212, 0.14);
      border-radius: 3px;
      box-shadow: inset 0 0 0 1.5px rgba(107, 127, 212, 0.30);
      color: inherit;
      padding: 1px 0;
    }

    /* ——— Share modal ——— */
    .share-backdrop {
      position: fixed;
      inset: 0;
      z-index: 1100;
      background: rgba(0, 0, 0, 0.18);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s;
      backdrop-filter: blur(2px);
    }

    .share-backdrop.visible {
      opacity: 1;
      visibility: visible;
    }

    .share-panel {
      position: fixed;
      top: 52px;
      right: 16px;
      width: 320px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.14), 0 0 0 1px rgba(0, 0, 0, 0.04);
      z-index: 1101;
      padding: 20px;
      transform: translateY(-4px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
    }

    .share-panel.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .share-panel-section {
      margin-bottom: 20px;
    }

    .share-panel-section:last-child {
      margin-bottom: 0;
    }

    .share-section-label {
      font-size: 11px;
      font-weight: 500;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .share-people-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .share-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7dd3fc 0%, #a78bfa 50%, #f472b6 100%);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
    }

    .share-person-info {
      flex: 1;
      min-width: 0;
    }

    .share-person-name {
      font-size: 13px;
      font-weight: 500;
      color: #1a1a1a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .share-person-email {
      font-size: 11px;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .share-access-chip {
      font-size: 11px;
      color: #666;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 20px;
      flex-shrink: 0;
    }

    .share-invite-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f7f7f7;
      border-radius: 10px;
      padding: 8px 12px;
    }

    .share-invite-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-family: var(--font);
      font-size: 13px;
      color: #1a1a1a;
      min-width: 0;
    }

    .share-invite-input::placeholder {
      color: #bbb;
    }

    .share-invite-btn {
      flex-shrink: 0;
      border: none;
      background: #1C1C1E;
      color: #fff;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 500;
      padding: 5px 12px;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }

    .share-invite-btn:hover {
      background: #2C2C2E;
    }

    .share-divider {
      height: 1px;
      background: #f0f0f0;
      margin: 16px 0;
    }

    .share-link-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f7f7f7;
      border-radius: 10px;
      padding: 8px 12px;
    }

    .share-link-url {
      flex: 1;
      font-size: 12px;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .share-link-copy {
      flex-shrink: 0;
      border: none;
      background: none;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 500;
      color: #6B7FD4;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: color 0.12s ease-out, transform 0.06s ease-out;
    }

    .share-link-copy:hover {
      color: #5a6bc4;
    }

    .share-social-grid {
      display: flex;
      gap: 10px;
    }

    .share-social-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 7px;
      padding: 12px 8px;
      border: 1.5px solid #f0f0f0;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      transition: border-color 0.12s ease-out, background 0.12s ease-out, transform 0.06s ease-out;
      text-decoration: none;
    }

    .share-social-btn:hover {
      border-color: #e0e0e0;
      background: #fafafa;
    }

    .share-social-btn span {
      font-family: var(--font);
      font-size: 11px;
      font-weight: 500;
      color: #666;
    }

    .share-social-btn svg {
      display: block;
    }

    .share-panel-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 24px;
      height: 24px;
      border: none;
      background: none;
      color: #bbb;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: color 0.12s ease-out, background 0.12s ease-out, transform 0.06s ease-out;
      line-height: 1;
    }

    .share-panel-close:hover {
      color: #555;
      background: #f0f0f0;
    }

    .share-copied-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(12px);
      background: #1C1C1E;
      color: #fff;
      font-size: 13px;
      padding: 8px 18px;
      border-radius: 20px;
      z-index: 1200;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
      pointer-events: none;
    }

    .share-copied-toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    /* ——— 1. Inline diff ——— */
    .diff-old {
      background: #FFEBEB;
      color: #c0392b;
      text-decoration: line-through;
      border-radius: 2px;
      padding: 1px 0;
    }
    .diff-new {
      background: #EBFFEF;
      color: #27ae60;
      border-radius: 2px;
      padding: 1px 0;
    }
    .diff-actions {
      position: fixed;
      display: flex;
      gap: 6px;
      z-index: 1050;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
    }
    .diff-actions.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .diff-btn {
      border: none;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 5px 12px;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.12s ease;
    }
    .diff-btn:hover { background: #f8f8f8; }
    .diff-btn-accept { color: #2D9B5A; }
    .diff-btn-reject { color: #D04040; }

    /* ——— 2. Focus mode ——— */
    .top-bar-inner {
      transition: opacity 0.3s ease;
    }
    body.focus-mode .sidebar { opacity: 0; pointer-events: none; }
    body.focus-mode .top-bar-inner { opacity: 0; pointer-events: none; }
    .focus-hint {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #ccc;
      font-family: var(--font);
      font-weight: 300;
      pointer-events: none;
      z-index: 900;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .focus-hint.visible { opacity: 1; }

    /* ——— 3. Slash command menu ——— */
    .slash-menu {
      position: fixed;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.10), 0 0 0 1px rgba(0,0,0,0.05);
      width: 220px;
      padding: 6px 0;
      z-index: 1050;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
    }
    .slash-menu.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .slash-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 14px;
      cursor: pointer;
      transition: background 0.1s ease;
    }
    .slash-item:hover, .slash-item.active {
      background: #f5f5f5;
    }
    .slash-item-icon {
      width: 22px;
      height: 22px;
      border-radius: 5px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #555;
      flex-shrink: 0;
    }
    .slash-item-label {
      font-size: 13px;
      font-weight: 500;
      color: #1a1a1a;
    }
    .slash-item-desc {
      font-size: 11px;
      color: #aaa;
      margin-top: 1px;
    }

    /* ——— 4. Word count ——— */
    .word-count {
      position: fixed;
      bottom: 24px;
      right: 32px;
      font-size: 11px;
      font-weight: 300;
      color: #C8C4BC;
      font-family: var(--font);
      pointer-events: none;
      z-index: 90;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .word-count.visible { opacity: 1; }

    /* ——— 5. Versions chip & dropdown ——— */
    .versions-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--sidebar-muted);
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      border-radius: 20px;
      padding: 3px 9px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
      position: relative;
    }
    .versions-chip:hover { background: rgba(0,0,0,0.08); }
    .versions-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 200px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 6px 0;
      z-index: 500;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
    }
    .versions-dropdown.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .version-item {
      display: block;
      padding: 8px 14px;
      font-size: 12px;
      color: #1a1a1a;
      cursor: pointer;
      transition: background 0.1s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: var(--font);
    }
    .version-item:hover { background: #f5f5f5; }
    .version-item-time {
      font-size: 11px;
      color: #aaa;
      display: block;
    }
    .editor-meta {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    /* ——— 6. Quote paste toast ——— */
    .quote-toast {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #1a1a1a;
      font-family: var(--font);
      z-index: 1050;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-6px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
    }
    .quote-toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .quote-toast-btn {
      border: none;
      background: none;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 6px;
    }
    .quote-toast-yes { color: #6B7FD4; }
    .quote-toast-yes:hover { background: #f0f0ff; }
    .quote-toast-no { color: #aaa; }
    .quote-toast-no:hover { background: #f5f5f5; }
    .editor-body blockquote {
      border-left: 2px solid #D4D0C9;
      padding-left: 18px;
      margin: 24px 0;
      font-style: italic;
      color: #5a5a5a;
      line-height: 1.7;
    }

    /* ——— Empty state ——— */
    #emptyState {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 12px;
      color: #bbb;
    }

    #emptyState.visible {
      display: flex;
    }

    .empty-state-icon {
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 15px;
      color: #aaa;
      font-weight: 300;
    }

    .empty-create-btn {
      color: #5B8AF0;
      background: none;
      border: none;
      font-size: 13px;
      font-family: var(--font);
      cursor: pointer;
      padding: 4px 0;
    }

    .empty-create-btn:hover {
      text-decoration: underline;
    }

    /* ——— Search empty ——— */
    #searchEmpty {
      display: none;
      font-size: 12px;
      color: #bbb;
      text-align: center;
      padding: 16px 8px;
    }

    #searchEmpty.visible {
      display: block;
    }

    /* ——— Editor meta saved indicator ——— */
    .editor-meta-row {
      display: flex;
      align-items: center;
    }

    /* ——— AI helper (floating bottom bar) ——— */
    .ai-helper {
      position: fixed;
      bottom: 24px;
      left: calc(120px + 50%);
      transform: translateX(-50%) translateY(4px);
      width: calc(100% - 340px);
      max-width: 480px;
      background: rgba(242, 239, 233, 0.97);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid #E6E6E6;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.05);
      padding: 9px 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 200;
    }

    body.sidebar-hidden .ai-helper,
    body.focus-mode .ai-helper {
      left: 50%;
    }

    .ai-helper.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    .ai-helper-label {
      font-size: 11px;
      color: #b8b8b8;
      line-height: 1.4;
      user-select: none;
      letter-spacing: 0.002em;
    }

    .ai-helper-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.55);
      border: 1px solid rgba(0, 0, 0, 0.07);
      border-radius: 7px;
      padding: 5px 5px 5px 9px;
    }

    .ai-helper-textarea {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-family: var(--font);
      font-size: 13px;
      color: #1a1a1a;
      resize: none;
      line-height: 1.5;
      min-height: 20px;
      max-height: 80px;
      overflow-y: auto;
      padding: 0;
      scrollbar-width: none;
    }

    .ai-helper-textarea::-webkit-scrollbar { display: none; }
    .ai-helper-textarea::placeholder { color: #c0c0c0; }

    .ai-helper-send {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.55);
      border: none;
      cursor: pointer;
      color: rgba(255,255,255,0.90);
      flex-shrink: 0;
      transition: background 0.1s ease, opacity 0.1s ease;
      outline: none;
    }

    .ai-helper-send:hover { background: rgba(0, 0, 0, 0.72); }
    .ai-helper-send:disabled { opacity: 0.25; cursor: default; }

    .ai-helper-spinner {
      width: 11px;
      height: 11px;
      border: 1.5px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: btnSpin 0.7s linear infinite;
      display: none;
    }

    .ai-helper-send.loading .ai-helper-spinner { display: block; }
    .ai-helper-send.loading .ai-helper-arrow { display: none; }

    @keyframes btnSpin { to { transform: rotate(360deg); } }

    /* Saved indicator badge */
    #savedIndicator {
      position: absolute;
      top: 8px;
      right: 0;
      font-size: 11px;
      font-family: var(--font);
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    #savedIndicator.visible {
      opacity: 1;
    }

    /* Editor title placeholder (color overridden below) */
    .editor-title:empty::before {
      content: attr(data-placeholder);
      pointer-events: none;
    }

    /* ——— Link styling inside editor (overridden below) ——— */

    /* ═══════════════════════════════════════════════
       FLOATING FORMAT TOOLBAR
    ═══════════════════════════════════════════════ */
    .fmt-bar {
      position: fixed;
      display: flex;
      align-items: center;
      gap: 1px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 4px 5px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.22), 0 0 0 1px rgba(255,255,255,0.05);
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(5px) translateX(-50%);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
    }
    .fmt-bar.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) translateX(-50%);
      pointer-events: auto;
    }
    .fmt-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 28px;
      border-radius: 5px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.78);
      cursor: pointer;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 600;
      transition: background 0.12s ease-out, color 0.12s ease-out, transform 0.06s ease-out;
      outline: none;
    }
    .fmt-btn:hover { background: rgba(255,255,255,0.11); color: #fff; }
    .fmt-btn:focus-visible { outline: 2px solid rgba(255,255,255,0.4); outline-offset: 1px; }
    .fmt-btn.active { color: #fff; background: rgba(255,255,255,0.16); }
    .fmt-sep {
      width: 1px;
      height: 16px;
      background: rgba(255,255,255,0.12);
      margin: 0 3px;
      flex-shrink: 0;
    }
    .fmt-ai-btn { font-size: 14px; width: 28px; color: rgba(255,255,255,0.55); }
    .fmt-ai-btn:hover { color: #fff; }

    /* Link input panel (appears below fmt-bar) */
    .fmt-link-panel {
      position: fixed;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 5px 6px 5px 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.22);
      z-index: 1101;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px) translateX(-50%);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
      min-width: 260px;
      pointer-events: none;
    }
    .fmt-link-panel.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) translateX(-50%);
      pointer-events: auto;
    }
    .fmt-link-input {
      flex: 1;
      border: none;
      background: transparent;
      color: #fff;
      font-family: var(--font);
      font-size: 12.5px;
      outline: none;
      min-width: 0;
    }
    .fmt-link-input::placeholder { color: rgba(255,255,255,0.3); }
    .fmt-link-apply {
      flex-shrink: 0;
      border: none;
      background: rgba(255,255,255,0.11);
      color: rgba(255,255,255,0.85);
      border-radius: 5px;
      padding: 4px 10px;
      font-family: var(--font);
      font-size: 11.5px;
      cursor: pointer;
      outline: none;
      transition: background 0.1s ease;
    }
    .fmt-link-apply:hover { background: rgba(255,255,255,0.20); }

    /* ═══════════════════════════════════════════════
       PARAGRAPH HANDLE (drag + type)
    ═══════════════════════════════════════════════ */
    #paraHandle {
      position: fixed;
      width: 18px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease;
      z-index: 60;
      color: #ccc;
      border-radius: 3px;
    }
    #paraHandle.visible { opacity: 1; pointer-events: auto; }
    #paraHandle:hover { color: #888; background: rgba(0,0,0,0.06); }
    #paraHandle:active { cursor: grabbing; }

    /* Block type context menu */
    #blockTypeMenu {
      position: fixed;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 28px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 5px 0;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transition: opacity 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.14s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.14s;
      min-width: 168px;
    }
    #blockTypeMenu.visible { opacity: 1; visibility: visible; transform: translateY(0); }
    .btype-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 12.5px;
      color: #1a1a1a;
      transition: background 0.08s ease;
    }
    .btype-item:hover { background: #f5f5f5; }
    .btype-item.active { background: #f0f0f0; font-weight: 500; }
    .btype-icon { font-size: 10.5px; font-weight: 700; color: #999; width: 20px; text-align: center; flex-shrink: 0; }

    /* ═══════════════════════════════════════════════
       DRAG REORDER
    ═══════════════════════════════════════════════ */
    #dragInsertLine {
      position: fixed;
      height: 2px;
      background: #6B7FD4;
      border-radius: 1px;
      z-index: 1200;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.08s ease;
    }
    #dragInsertLine.visible { opacity: 1; }

    #dragDeleteZone {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: linear-gradient(to top, rgba(210,64,64,0.10), transparent);
      border-top: 1.5px dashed rgba(210,64,64,0.22);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      z-index: 1200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      font-family: var(--font);
      font-size: 11.5px;
      color: rgba(210,64,64,0.55);
    }
    #dragDeleteZone.visible { opacity: 1; }
    #dragDeleteZone.active {
      background: linear-gradient(to top, rgba(210,64,64,0.20), transparent);
      border-top-color: rgba(210,64,64,0.45);
      color: rgba(210,64,64,0.85);
    }

    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1300;
      opacity: 0.78;
      background: #fff;
      border-radius: 6px;
      padding: 6px 12px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.16);
      transform: rotate(1deg) scale(0.97);
      font-family: var(--font);
      font-size: 13.5px;
      color: #3a3a3a;
      max-width: 420px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .block-dragging { opacity: 0.28; }

    @media (prefers-reduced-motion: reduce) {
      .fmt-bar, .fmt-link-panel, #blockTypeMenu, #paraHandle,
      #dragInsertLine, #dragDeleteZone { transition: none; }
    }

    /* ═══════════════════════════════════════════════
       SELECTION + WRITING FEEDBACK
    ═══════════════════════════════════════════════ */
    ::selection {
      background: rgba(60, 100, 255, 0.18);
    }
    .editor-body ::selection,
    .editor-title ::selection {
      background: rgba(60, 100, 255, 0.20);
    }

    /* ═══════════════════════════════════════════════
       EDITOR BODY — LIST SPACING
    ═══════════════════════════════════════════════ */
    .editor-body ul,
    .editor-body ol {
      margin: 4px 0 15px;
      padding-left: 1.6em;
    }
    .editor-body ul ul,
    .editor-body ol ol {
      margin: 2px 0 2px 0.4em;
    }

    /* ═══════════════════════════════════════════════
       LINK STYLE — SOFTER
    ═══════════════════════════════════════════════ */
    .editor-body a {
      color: #4a5ec4;
      text-decoration: underline;
      text-underline-offset: 2px;
      text-decoration-color: rgba(74, 94, 196, 0.35);
    }
    .editor-body a:hover {
      color: #3548ad;
      text-decoration-color: rgba(53, 72, 173, 0.55);
    }

    /* ═══════════════════════════════════════════════
       TITLE PLACEHOLDER — SOFTER
    ═══════════════════════════════════════════════ */
    .editor-title:empty::before {
      color: #c8c8c8;
    }

    /* ═══════════════════════════════════════════════
       MICRO-INTERACTIONS
    ═══════════════════════════════════════════════ */

    /* ── Press feedback: scale(0.98) on :active, 60ms snap ── */
    /* Principle: fast physical acknowledgment, no bounce */
    .top-bar button:active,
    .top-bar .top-bar-btn:active,
    .top-bar .btn-share:active,
    .btn-toggle-sidebar:active,
    .sidebar-reveal-btn:active,
    .btn-new-note:active,
    .btn-delete-doc:active,
    .btn-theme-toggle:active,
    .empty-create-btn:active,
    .share-invite-btn:active,
    .share-link-copy:active,
    .share-social-btn:active,
    .share-panel-close:active,
    .diff-btn:active,
    .quote-toast-btn:active,
    .version-item:active,
    .floating-chat-mood-btn:active,
    .fmt-link-apply:active {
      transform: scale(0.98);
      transition: transform 0.06s ease-out !important;
    }

    /* Fmt-bar buttons — tighter press (contained in dark bar) */
    .fmt-btn:active {
      transform: scale(0.97);
      transition: transform 0.06s ease-out !important;
    }

    /* Para handle — keep :active grabbing cursor, add scale */
    #paraHandle:active {
      cursor: grabbing;
      transform: scale(0.92);
      transition: transform 0.06s ease-out !important;
    }

    /* ── Format-applied feedback flash ── */
    /* Applied to .editor-wrap via JS after execCommand */
    @keyframes fmtFlash {
      0%   { opacity: 1; }
      20%  { opacity: 0.88; }
      100% { opacity: 1; }
    }
    .editor-wrap.fmt-feedback {
      animation: fmtFlash 280ms ease-out forwards;
    }
    /* The ::after overlay renders the tint (opacity-only animation = GPU, no layout) */
    .editor-wrap.fmt-feedback::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 6px;
      background: rgba(60, 100, 255, 0.05);
      pointer-events: none;
      animation: fmtFlashOverlay 280ms ease-out forwards;
      z-index: 0;
    }
    @keyframes fmtFlashOverlay {
      0%   { opacity: 1; }
      100% { opacity: 0; }
    }

    /* ── AI generation pulse (replaces center-spinner feel) ── */
    /* Applied to .ai-helper-send.loading */
    @keyframes generatePulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.72; }
    }
    .ai-helper-send.loading {
      animation: generatePulse 1.4s ease-in-out infinite;
    }

    /* Floating chat send button pulse during generation */
    @keyframes chatSendPulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.74; }
    }
    .floating-chat-send.loading {
      animation: chatSendPulse 1.4s ease-in-out infinite;
    }

    /* ── Slash menu items: instant hover (no lag) ── */
    .slash-item { transition: background 0.08s ease-out; }
    .btype-item  { transition: background 0.08s ease-out; }

    /* ── Theme toggle: icon opacity feedback ── */
    .btn-theme-toggle .theme-icon {
      transition: opacity 0.12s ease-out;
    }
    .btn-theme-toggle:hover .theme-icon { opacity: 1; }

    /* ── Diff action buttons ── */
    .diff-btn { transition: background 0.12s ease-out, transform 0.06s ease-out; }

    /* ── Version items ── */
    .version-item { transition: background 0.08s ease-out; }

    /* ── Share social buttons ── */
    .share-social-btn {
      transition: border-color 0.12s ease-out, background 0.12s ease-out, transform 0.06s ease-out;
    }

    /* ── Btype items: add transition explicitly ── */
    .btype-item { transition: background 0.08s ease-out; }

    /* ── Share invite btn ── */
    .share-invite-btn {
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }

    /* ── Dark mode: pulse adapts to surface ── */
    [data-theme="dark"] .editor-wrap.fmt-feedback::after {
      background: rgba(139, 157, 255, 0.07);
    }

    /* ═══════════════════════════════════════════════
       SIDEBAR FOOTER (theme toggle — fixed at bottom)
    ═══════════════════════════════════════════════ */
    .sidebar-footer {
      flex-shrink: 0;
      padding: 0 2px 2px;
    }
    .sidebar-footer-divider {
      height: 1px;
      background: rgba(0, 0, 0, 0.07);
      margin: 0 8px 6px;
    }
    /* Email shown at the very bottom of the sidebar */
    .sidebar-email {
      padding: 3px 10px 10px;
      font-size: 10px;
      color: var(--sidebar-muted);
      opacity: 0.50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
      pointer-events: none;
    }

    /* ═══════════════════════════════════════════════
       USER PROFILE WIDGET (sidebar footer)
    ═══════════════════════════════════════════════ */
    .user-widget {
      position: relative;
      margin-bottom: 2px;
    }
    .btn-user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 10px;
      background: none;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 12.5px;
      font-weight: 400;
      color: var(--sidebar-text);
      text-align: left;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
      min-width: 0; /* allow truncation */
    }
    .btn-user-profile:hover { background: var(--sidebar-active); }
    .btn-user-profile:active { transform: scale(0.98); }

    /* Avatar circle */
    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10.5px;
      font-weight: 500;
      letter-spacing: 0;
      color: #fff;
      background: #7a7a7a; /* default; overridden by JS */
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    /* Name + email */
    .user-name-text {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--sidebar-text);
      font-size: 12.5px;
      opacity: 0.85;
    }

    /* Chevron */
    .user-chevron {
      flex-shrink: 0;
      opacity: 0.35;
      transition: opacity 0.12s ease-out;
    }
    .btn-user-profile:hover .user-chevron { opacity: 0.6; }

    /* ——— User popover ——— */
    .user-popover {
      position: absolute;
      bottom: calc(100% + 6px);
      left: 4px;
      right: 4px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
      padding: 4px;
      z-index: 200;
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.2,0.8,0.2,1), transform 0.14s cubic-bezier(0.2,0.8,0.2,1);
    }
    .user-popover.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* Popover: user info header */
    .user-popover-header {
      padding: 9px 10px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.07);
      margin-bottom: 4px;
    }
    .user-popover-email {
      font-size: 11.5px;
      color: var(--sidebar-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Popover items */
    .user-popover-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 10px;
      background: none;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 12.5px;
      font-weight: 400;
      color: var(--sidebar-text);
      text-align: left;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
    }
    .user-popover-item:hover { background: rgba(0,0,0,0.05); }
    .user-popover-item:active { transform: scale(0.98); }
    .user-popover-item.danger { color: #d0393a; }
    .user-popover-item.danger:hover { background: rgba(208,57,58,0.07); }
    .user-popover-item svg { opacity: 0.6; flex-shrink: 0; }
    .user-popover-item.danger svg { opacity: 0.75; }

    /* ═══════════════════════════════════════════════
       THEME TRANSITION (applied only during manual toggle)
    ═══════════════════════════════════════════════ */
    .theme-transition,
    .theme-transition * {
      transition-property: background-color, color, border-color, fill, stroke !important;
      transition-duration: 0.1s !important;
      transition-timing-function: ease !important;
    }

    /* ═══════════════════════════════════════════════
       DARK MODE  [data-theme="dark"]
       Intentional editorial dark — NOT an inversion
    ═══════════════════════════════════════════════ */

    /* Core surfaces */
    html[data-theme="dark"],
    [data-theme="dark"] body {
      background: #1C1C1E;
      color: #E6E6E6;
    }

    /* Sidebar */
    [data-theme="dark"] .sidebar        { background: #202022; color: #E6E6E6; }
    [data-theme="dark"] .btn-toggle-sidebar { color: rgba(255,255,255,0.38); }
    [data-theme="dark"] .btn-toggle-sidebar:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.72); }
    [data-theme="dark"] .window-icon    { border-color: rgba(255,255,255,0.08); background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .search-wrap    { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.07); }
    [data-theme="dark"] .search-wrap input { color: #E6E6E6; }
    [data-theme="dark"] .search-wrap input::placeholder { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .search-shortcut { color: rgba(255,255,255,0.3); }

    [data-theme="dark"] .btn-new-note {
      color: rgba(255,255,255,0.42);
      border-color: rgba(255,255,255,0.09);
      background: transparent;
    }
    [data-theme="dark"] .btn-new-note:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.78);
    }

    [data-theme="dark"] .doc-item:hover  { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .doc-item.active { background: rgba(255,255,255,0.07); border-left-color: transparent; }
    [data-theme="dark"] .doc-item-title  { color: #D8D8D8; }
    [data-theme="dark"] .doc-item-title.untitled { color: rgba(255,255,255,0.32); }
    [data-theme="dark"] .doc-item-preview       { color: rgba(255,255,255,0.32); }
    [data-theme="dark"] .doc-item-preview.empty { color: rgba(255,255,255,0.2); }
    [data-theme="dark"] .doc-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
    [data-theme="dark"] .btn-delete-doc { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .btn-delete-doc:hover { color: #e08080; background: rgba(192,57,43,0.15); }
    [data-theme="dark"] #searchEmpty    { color: rgba(255,255,255,0.25); }

    [data-theme="dark"] .sidebar-reveal-btn {
      background: rgba(42,42,46,0.92);
      box-shadow: 0 2px 10px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.06);
      color: #A1A1AA;
    }

    /* Sidebar footer */
    [data-theme="dark"] .sidebar-footer-divider { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .sidebar-email { color: rgba(255,255,255,0.28); opacity: 1; }

    /* Theme pill — dark mode: thumb slides right */
    [data-theme="dark"] .theme-pill,
    [data-theme="dark"] .top-bar .theme-pill {
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.12);
    }
    [data-theme="dark"] .theme-pill:hover,
    [data-theme="dark"] .top-bar .theme-pill:hover { background: rgba(255,255,255,0.16); }
    [data-theme="dark"] .tp-thumb {
      background: #4a4a4a;
      transform: translateY(-50%) translateX(22px);
    }
    [data-theme="dark"] .tp-icon { color: rgba(255,255,255,0.50); }

    /* User profile widget — dark */
    [data-theme="dark"] .btn-user-profile        { color: #E6E6E6; }
    [data-theme="dark"] .btn-user-profile:hover  { background: rgba(255,255,255,0.06); }
    [data-theme="dark"] .user-name-text          { color: #E6E6E6; }
    [data-theme="dark"] .user-popover {
      background: #2A2A2E;
      border-color: rgba(255,255,255,0.09);
      box-shadow: 0 8px 28px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .user-popover-header     { border-color: rgba(255,255,255,0.08); }
    [data-theme="dark"] .user-popover-email      { color: rgba(255,255,255,0.38); }
    [data-theme="dark"] .user-popover-item       { color: #E6E6E6; }
    [data-theme="dark"] .user-popover-item:hover { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .user-popover-item.danger         { color: #ff6b6b; }
    [data-theme="dark"] .user-popover-item.danger:hover   { background: rgba(255,107,107,0.1); }

    /* Top bar */
    [data-theme="dark"] .top-bar button,
    [data-theme="dark"] .top-bar .top-bar-btn { color: #A1A1AA; }
    [data-theme="dark"] .top-bar button:hover,
    [data-theme="dark"] .top-bar .top-bar-btn:hover { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .top-bar .btn-share {
      color: rgba(200,200,200,0.32);
      border-color: rgba(255,255,255,0.09);
      background: transparent;
    }
    [data-theme="dark"] .top-bar .btn-share:hover {
      background: rgba(255,255,255,0.07);
      color: #C0C0C0;
      border-color: rgba(255,255,255,0.14);
    }

    /* Editor title + body */
    [data-theme="dark"] .editor-title { color: #E6E6E6; }
    [data-theme="dark"] .editor-title::placeholder { color: rgba(255,255,255,0.2); }
    [data-theme="dark"] .editor-title:empty::before { color: rgba(255,255,255,0.2) !important; }
    [data-theme="dark"] .editor-title,
    [data-theme="dark"] .editor-body   { caret-color: #E6E6E6; }
    [data-theme="dark"] .editor-body   { color: #E6E6E6; }
    [data-theme="dark"] .editor-body p { color: #E6E6E6; }
    [data-theme="dark"] .editor-body h1,
    [data-theme="dark"] .editor-body h2,
    [data-theme="dark"] .editor-body h3 { color: #E0E0E0; }
    [data-theme="dark"] .editor-body ul li,
    [data-theme="dark"] .editor-body ol li { color: #E6E6E6; }
    [data-theme="dark"] .editor-body ul ul li,
    [data-theme="dark"] .editor-body ol ol li { color: #C0C0C0; }
    [data-theme="dark"] .editor-body blockquote {
      border-left-color: rgba(255,255,255,0.14);
      color: #A1A1AA;
    }
    [data-theme="dark"] .editor-body a {
      color: #8B9DFF;
      text-decoration-color: rgba(139,157,255,0.35);
    }
    [data-theme="dark"] .editor-body a:hover {
      color: #a3b0ff;
      text-decoration-color: rgba(163,176,255,0.55);
    }
    [data-theme="dark"] .editor-body:empty::before { color: rgba(255,255,255,0.22); }
    [data-theme="dark"] #savedIndicator { color: #A1A1AA; }

    /* Dark selection */
    [data-theme="dark"] ::selection,
    [data-theme="dark"] .editor-body ::selection,
    [data-theme="dark"] .editor-title ::selection { background: rgba(139,157,255,0.25); }

    /* Versions chip */
    [data-theme="dark"] .versions-chip {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.09);
      color: rgba(255,255,255,0.45);
    }
    [data-theme="dark"] .versions-chip:hover   { background: rgba(255,255,255,0.10); }
    [data-theme="dark"] .versions-dropdown {
      background: #252528;
      box-shadow: 0 4px 20px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .version-item          { color: #E6E6E6; }
    [data-theme="dark"] .version-item:hover    { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .version-item-time     { color: rgba(255,255,255,0.35); }

    /* Floating AI chat */
    [data-theme="dark"] .floating-chat {
      background: #252528;
      box-shadow: 0 4px 24px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .floating-chat::before { background: #252528; filter: none; }
    [data-theme="dark"] .floating-chat-input   { color: #E6E6E6; }
    [data-theme="dark"] .floating-chat-input::placeholder { color: rgba(255,255,255,0.25); }
    [data-theme="dark"] .floating-chat-sep     { background: rgba(255,255,255,0.08); }
    [data-theme="dark"] .floating-chat-mood-btn {
      background: rgba(139,157,255,0.14);
      color: #8B9DFF;
    }
    [data-theme="dark"] .floating-chat-mood-btn:hover { background: rgba(139,157,255,0.22); }
    [data-theme="dark"] .floating-chat-mood-dropdown {
      background: #2A2A2E;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    [data-theme="dark"] .floating-chat-mood-option       { color: #E6E6E6; }
    [data-theme="dark"] .floating-chat-mood-option:hover { background: rgba(255,255,255,0.07); }

    /* AI helper */
    [data-theme="dark"] .ai-helper {
      background: rgba(255,255,255,0.025);
      border-color: rgba(255,255,255,0.07);
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    [data-theme="dark"] .ai-helper-label    { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .ai-helper-pill     { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }
    [data-theme="dark"] .ai-helper-textarea { color: #E6E6E6; }
    [data-theme="dark"] .ai-helper-textarea::placeholder { color: rgba(255,255,255,0.22); }
    [data-theme="dark"] .ai-helper-send     { background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.82); }
    [data-theme="dark"] .ai-helper-send:hover { background: rgba(255,255,255,0.18); }

    /* Slash menu */
    [data-theme="dark"] .slash-menu {
      background: #252528;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .slash-item:hover,
    [data-theme="dark"] .slash-item.active    { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .slash-item-icon      { background: rgba(255,255,255,0.08); color: #A1A1AA; }
    [data-theme="dark"] .slash-item-label     { color: #E6E6E6; }
    [data-theme="dark"] .slash-item-desc      { color: rgba(255,255,255,0.35); }

    /* Block type menu */
    [data-theme="dark"] #blockTypeMenu {
      background: #252528;
      box-shadow: 0 6px 28px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .btype-item        { color: #E6E6E6; }
    [data-theme="dark"] .btype-item:hover  { background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .btype-item.active { background: rgba(255,255,255,0.10); }
    [data-theme="dark"] .btype-icon        { color: rgba(255,255,255,0.35); }

    /* Drag ghost */
    [data-theme="dark"] .drag-ghost {
      background: #2A2A2E;
      color: #E6E6E6;
      box-shadow: 0 8px 28px rgba(0,0,0,0.4);
    }

    /* Diff review */
    [data-theme="dark"] .diff-old          { background: rgba(192,57,43,0.20); color: #e08080; }
    [data-theme="dark"] .diff-new          { background: rgba(39,174,96,0.18); color: #72d99a; }
    [data-theme="dark"] .diff-btn {
      background: #2A2A2E;
      color: #E6E6E6;
      box-shadow: 0 2px 12px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .diff-btn:hover    { background: #343438; }

    /* Focus hint + word count */
    [data-theme="dark"] .focus-hint        { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .word-count        { color: rgba(255,255,255,0.2); }

    /* Share panel */
    [data-theme="dark"] .share-backdrop    { background: rgba(0,0,0,0.55); }
    [data-theme="dark"] .share-panel {
      background: #252528;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .share-section-label   { color: rgba(255,255,255,0.35); }
    [data-theme="dark"] .share-person-name     { color: #E6E6E6; }
    [data-theme="dark"] .share-person-email    { color: rgba(255,255,255,0.4); }
    [data-theme="dark"] .share-access-chip     { background: rgba(255,255,255,0.08); color: #A1A1AA; }
    [data-theme="dark"] .share-invite-row      { background: rgba(255,255,255,0.06); }
    [data-theme="dark"] .share-invite-input    { color: #E6E6E6; }
    [data-theme="dark"] .share-invite-input::placeholder { color: rgba(255,255,255,0.25); }
    [data-theme="dark"] .share-invite-btn      { background: rgba(255,255,255,0.12); color: #E6E6E6; }
    [data-theme="dark"] .share-invite-btn:hover { background: rgba(255,255,255,0.18); }
    [data-theme="dark"] .share-divider         { background: rgba(255,255,255,0.06); }
    [data-theme="dark"] .share-link-row        { background: rgba(255,255,255,0.06); }
    [data-theme="dark"] .share-link-url        { color: rgba(255,255,255,0.38); }
    [data-theme="dark"] .share-link-copy       { color: #8B9DFF; }
    [data-theme="dark"] .share-link-copy:hover { color: #a3b0ff; }
    [data-theme="dark"] .share-social-btn      { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }
    [data-theme="dark"] .share-social-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.12); }
    [data-theme="dark"] .share-social-btn span { color: rgba(255,255,255,0.5); }
    [data-theme="dark"] .share-panel-close     { color: rgba(255,255,255,0.3); }
    [data-theme="dark"] .share-panel-close:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.07); }
    [data-theme="dark"] .share-copied-toast    { background: #3A3A3E; color: #E6E6E6; }

    /* Quote toast */
    [data-theme="dark"] .quote-toast {
      background: #252528;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.07);
      color: #E6E6E6;
    }
    [data-theme="dark"] .quote-toast-yes       { color: #8B9DFF; }
    [data-theme="dark"] .quote-toast-yes:hover { background: rgba(139,157,255,0.12); }
    [data-theme="dark"] .quote-toast-no        { color: rgba(255,255,255,0.35); }
    [data-theme="dark"] .quote-toast-no:hover  { background: rgba(255,255,255,0.07); }

    /* Empty state */
    [data-theme="dark"] .empty-state-text { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .empty-create-btn { color: #8B9DFF; }

    /* ═══════════════════════════════════════════════
       AI EDIT BAR  — shown on text selection (below selection)
    ═══════════════════════════════════════════════ */
    .ai-edit-bar {
      position: fixed;
      display: flex;
      align-items: center;
      gap: 1px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 9px;
      padding: 4px 5px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.10), 0 0 0 1px rgba(0,0,0,0.04);
      z-index: 1102;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px) translateX(-50%);
      transition: opacity 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  transform 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  visibility 0.14s;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
    }
    .ai-edit-bar.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) translateX(-50%);
      pointer-events: auto;
    }
    .ai-edit-bar-label {
      font-size: 10px;
      font-weight: 500;
      color: rgba(0,0,0,0.30);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 0 6px 0 4px;
      flex-shrink: 0;
    }
    .ai-edit-action-btn {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 4px 8px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: #1a1a1a;
      cursor: pointer;
      font-family: var(--font);
      font-size: 12px;
      font-weight: 450;
      letter-spacing: -0.01em;
      transition: background 0.12s ease-out, color 0.12s ease-out, transform 0.06s ease-out;
      outline: none;
      white-space: nowrap;
    }
    .ai-edit-action-btn:hover { background: rgba(0,0,0,0.06); color: #000; }
    .ai-edit-action-btn:active {
      transform: scale(0.98);
      transition: transform 0.06s ease-out !important;
    }
    .ai-edit-action-btn.loading {
      opacity: 0.5;
      pointer-events: none;
      animation: generatePulse 1.4s ease-in-out infinite;
    }
    .ai-edit-chevron { opacity: 0.45; flex-shrink: 0; }
    .ai-edit-sep {
      width: 1px;
      height: 14px;
      background: rgba(0,0,0,0.09);
      margin: 0 3px;
      flex-shrink: 0;
    }
    .ai-edit-close-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 5px;
      border: none;
      background: transparent;
      color: rgba(0,0,0,0.30);
      cursor: pointer;
      transition: background 0.12s ease-out, color 0.12s ease-out, transform 0.06s ease-out;
      outline: none;
      flex-shrink: 0;
    }
    .ai-edit-close-btn:hover { background: rgba(0,0,0,0.06); color: rgba(0,0,0,0.65); }
    .ai-edit-close-btn:active { transform: scale(0.98); }

    /* ——— Tone / More dropdowns ——— */
    .ai-edit-dd-wrap { position: relative; }
    .ai-edit-dd {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 9px;
      padding: 4px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.11), 0 0 0 1px rgba(0,0,0,0.04);
      min-width: 138px;
      z-index: 1104;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px);
      transition: opacity 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  transform 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  visibility 0.14s;
      pointer-events: none;
    }
    .ai-edit-dd.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }
    .ai-edit-dd-item {
      display: block;
      width: 100%;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-family: var(--font);
      font-size: 12px;
      color: #1a1a1a;
      text-align: left;
      cursor: pointer;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
      outline: none;
      white-space: nowrap;
    }
    .ai-edit-dd-item:hover { background: rgba(0,0,0,0.06); }
    .ai-edit-dd-item:active { transform: scale(0.98); }

    /* ═══════════════════════════════════════════════
       AI EDIT RESULTS PANEL
    ═══════════════════════════════════════════════ */
    .ai-edit-results {
      position: fixed;
      width: 370px;
      max-width: calc(100vw - 32px);
      background: #fff;
      border: 1px solid rgba(0,0,0,0.09);
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 6px 28px rgba(0,0,0,0.11), 0 0 0 1px rgba(0,0,0,0.04);
      z-index: 1103;
      opacity: 0;
      visibility: hidden;
      transform: translateY(4px) translateX(-50%);
      transition: opacity 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  transform 0.14s cubic-bezier(0.2,0.8,0.2,1),
                  visibility 0.14s;
      pointer-events: none;
      overflow: hidden;
    }
    .ai-edit-results.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) translateX(-50%);
      pointer-events: auto;
    }

    /* Loading row */
    .ai-edit-loading-row {
      display: none;
      align-items: center;
      gap: 9px;
      padding: 13px 14px;
      font-size: 12.5px;
      color: #999;
    }
    .ai-edit-loading-row.on { display: flex; }
    .ai-edit-result-spinner {
      width: 13px;
      height: 13px;
      border: 1.5px solid rgba(0,0,0,0.10);
      border-top-color: #888;
      border-radius: 50%;
      animation: btnSpin 0.8s linear infinite;
      flex-shrink: 0;
    }

    /* Alternatives list */
    .ai-edit-alts-list { display: none; }
    .ai-edit-alts-list.on { display: block; }

    .ai-edit-alt-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 11px 14px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: background 0.12s ease-out;
    }
    .ai-edit-alt-row:last-child { border-bottom: none; }
    .ai-edit-alt-row:hover { background: rgba(0,0,0,0.025); }
    .ai-edit-alt-row.sel { background: rgba(60,100,255,0.05); }
    .ai-edit-alt-row.sel:hover { background: rgba(60,100,255,0.075); }

    /* Radio dot */
    .ai-edit-alt-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1.5px solid rgba(0,0,0,0.18);
      flex-shrink: 0;
      margin-top: 2px;
      transition: border-color 0.12s ease, background 0.12s ease;
      position: relative;
    }
    .ai-edit-alt-row.sel .ai-edit-alt-dot {
      border-color: #3C64FF;
      background: #3C64FF;
    }
    .ai-edit-alt-row.sel .ai-edit-alt-dot::after {
      content: '';
      position: absolute;
      inset: 3px;
      border-radius: 50%;
      background: #fff;
    }

    .ai-edit-alt-body { flex: 1; min-width: 0; }
    .ai-edit-alt-tag {
      font-size: 10px;
      font-weight: 500;
      color: rgba(0,0,0,0.32);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 3px;
    }
    .ai-edit-alt-row.sel .ai-edit-alt-tag { color: #3C64FF; }
    .ai-edit-alt-text {
      font-size: 13px;
      line-height: 1.55;
      color: #1a1a1a;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
    }
    .ai-edit-alt-row.expanded .ai-edit-alt-text { -webkit-line-clamp: unset; }
    .ai-edit-alt-expand {
      font-size: 11px;
      color: rgba(0,0,0,0.35);
      background: none;
      border: none;
      padding: 2px 0 0;
      cursor: pointer;
      font-family: var(--font);
      display: none;
      transition: color 0.12s ease-out;
    }
    .ai-edit-alt-expand.show { display: inline; }
    .ai-edit-alt-expand:hover { color: rgba(0,0,0,0.6); text-decoration: underline; }

    /* Error row */
    .ai-edit-error-row {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      font-size: 12.5px;
      color: #999;
    }
    .ai-edit-error-row.on { display: flex; }
    .ai-edit-retry-btn {
      flex-shrink: 0;
      font-size: 12px;
      color: #3C64FF;
      background: none;
      border: none;
      cursor: pointer;
      font-family: var(--font);
      padding: 0;
      transition: opacity 0.12s ease;
    }
    .ai-edit-retry-btn:hover { opacity: 0.7; }

    /* Footer */
    .ai-edit-results-footer {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 8px 10px;
      border-top: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.015);
    }
    .ai-edit-results-footer.on { display: flex; }
    .ai-edit-apply {
      display: flex;
      align-items: center;
      height: 27px;
      padding: 0 10px;
      border-radius: 6px;
      border: none;
      font-family: var(--font);
      font-size: 11.5px;
      font-weight: 450;
      letter-spacing: -0.01em;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.12s ease-out, transform 0.06s ease-out;
      outline: none;
    }
    .ai-edit-apply:active { transform: scale(0.98); }
    .ai-edit-apply-replace {
      background: #1a1a1a;
      color: #fff;
    }
    .ai-edit-apply-replace:hover { background: #2e2e2e; }
    .ai-edit-apply-insert {
      background: rgba(0,0,0,0.06);
      color: #1a1a1a;
    }
    .ai-edit-apply-insert:hover { background: rgba(0,0,0,0.10); }
    .ai-edit-apply-cancel {
      background: transparent;
      color: rgba(0,0,0,0.40);
      margin-left: auto;
    }
    .ai-edit-apply-cancel:hover { background: rgba(0,0,0,0.04); color: rgba(0,0,0,0.65); }

    /* ——— AI Edit Bar — dark mode ——— */
    [data-theme="dark"] .ai-edit-bar {
      background: #2A2A2E;
      border-color: rgba(255,255,255,0.09);
      box-shadow: 0 4px 20px rgba(0,0,0,0.40), 0 0 0 1px rgba(255,255,255,0.06);
    }
    [data-theme="dark"] .ai-edit-bar-label       { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .ai-edit-action-btn      { color: rgba(255,255,255,0.75); }
    [data-theme="dark"] .ai-edit-action-btn:hover{ background: rgba(255,255,255,0.09); color: #fff; }
    [data-theme="dark"] .ai-edit-sep             { background: rgba(255,255,255,0.10); }
    [data-theme="dark"] .ai-edit-close-btn       { color: rgba(255,255,255,0.30); }
    [data-theme="dark"] .ai-edit-close-btn:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.65); }
    [data-theme="dark"] .ai-edit-dd {
      background: #2A2A2E;
      border-color: rgba(255,255,255,0.09);
      box-shadow: 0 8px 28px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .ai-edit-dd-item       { color: rgba(255,255,255,0.75); }
    [data-theme="dark"] .ai-edit-dd-item:hover { background: rgba(255,255,255,0.08); }

    /* Results panel — dark */
    [data-theme="dark"] .ai-edit-results {
      background: #252528;
      border-color: rgba(255,255,255,0.08);
      box-shadow: 0 8px 32px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.07);
    }
    [data-theme="dark"] .ai-edit-loading-row   { color: rgba(255,255,255,0.38); }
    [data-theme="dark"] .ai-edit-result-spinner{ border-color: rgba(255,255,255,0.10); border-top-color: rgba(255,255,255,0.55); }
    [data-theme="dark"] .ai-edit-alt-row       { border-color: rgba(255,255,255,0.06); }
    [data-theme="dark"] .ai-edit-alt-row:hover { background: rgba(255,255,255,0.04); }
    [data-theme="dark"] .ai-edit-alt-row.sel   { background: rgba(139,157,255,0.10); }
    [data-theme="dark"] .ai-edit-alt-row.sel:hover { background: rgba(139,157,255,0.14); }
    [data-theme="dark"] .ai-edit-alt-dot       { border-color: rgba(255,255,255,0.20); }
    [data-theme="dark"] .ai-edit-alt-row.sel .ai-edit-alt-dot { border-color: #8B9DFF; background: #8B9DFF; }
    [data-theme="dark"] .ai-edit-alt-tag       { color: rgba(255,255,255,0.32); }
    [data-theme="dark"] .ai-edit-alt-row.sel .ai-edit-alt-tag { color: #8B9DFF; }
    [data-theme="dark"] .ai-edit-alt-text      { color: #E6E6E6; }
    [data-theme="dark"] .ai-edit-alt-expand    { color: rgba(255,255,255,0.28); }
    [data-theme="dark"] .ai-edit-alt-expand:hover { color: rgba(255,255,255,0.58); }
    [data-theme="dark"] .ai-edit-error-row     { color: rgba(255,255,255,0.38); }
    [data-theme="dark"] .ai-edit-retry-btn     { color: #8B9DFF; }
    [data-theme="dark"] .ai-edit-results-footer{ background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.07); }
    [data-theme="dark"] .ai-edit-apply-replace { background: #E6E6E6; color: #1a1a1a; }
    [data-theme="dark"] .ai-edit-apply-replace:hover { background: #d4d4d4; }
    [data-theme="dark"] .ai-edit-apply-insert  { background: rgba(255,255,255,0.09); color: rgba(255,255,255,0.75); }
    [data-theme="dark"] .ai-edit-apply-insert:hover { background: rgba(255,255,255,0.14); }
    [data-theme="dark"] .ai-edit-apply-cancel  { color: rgba(255,255,255,0.30); }
    [data-theme="dark"] .ai-edit-apply-cancel:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.60); }
  </style>
</head>
<body>
  <header class="top-bar">
    <div class="top-bar-inner">
      <!-- Theme pill toggle -->
      <button type="button" class="theme-pill" id="themePill" title="Toggle appearance" aria-label="Toggle light/dark mode">
        <!-- Sun icon (left = light side) -->
        <span class="tp-icon tp-icon-sun" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </span>
        <!-- Moon icon (right = dark side) -->
        <span class="tp-icon tp-icon-moon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </span>
        <!-- Sliding thumb -->
        <span class="tp-thumb"></span>
      </button>
      <button type="button" class="btn-share" title="Compartir">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Share
      </button>
    </div>
  </header>

  <aside class="sidebar">
    <div class="window-chrome">
      <div class="window-dots">
        <span class="window-dot red"></span>
        <span class="window-dot yellow"></span>
        <span class="window-dot green"></span>
      </div>
      <button type="button" class="btn-toggle-sidebar" id="btnToggleSidebar" title="Ocultar sidebar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
      </button>
    </div>
    <div class="search-row">
      <div class="search-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="searchInput" placeholder="Search" autocomplete="off">
        <span class="search-shortcut">⌘K</span>
      </div>
    </div>

    <button type="button" class="btn-new-note" id="btnNewNote">+ Nueva nota</button>

    <nav class="doc-list" id="docList"></nav>
    <div id="searchEmpty">No encontramos nada</div>

    <div class="sidebar-footer">
      <div class="sidebar-footer-divider"></div>

      <!-- User profile widget -->
      <div class="user-widget" id="userWidget">
        <button type="button" class="btn-user-profile" id="btnUserProfile" title="Account">
          <span class="user-avatar" id="userAvatar"></span>
          <span class="user-name-text" id="userNameText">…</span>
          <svg class="user-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <div class="user-popover" id="userPopover" role="menu" aria-label="Account menu">
          <div class="user-popover-header">
            <div class="user-popover-email" id="userPopoverEmail"></div>
          </div>
          <button type="button" class="user-popover-item danger" id="btnLogout" role="menuitem">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Log out
          </button>
        </div>
      </div>

      <!-- User email shown at the bottom of sidebar -->
      <div class="sidebar-email" id="sidebarEmail"></div>
    </div>
  </aside>

  <!-- Floating button to reveal hidden sidebar -->
  <button type="button" class="sidebar-reveal-btn" id="sidebarRevealBtn" title="Mostrar sidebar">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
  </button>

  <main class="main">
    <div id="emptyState">
      <svg class="empty-state-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <span class="empty-state-text">Todavía no tenés notas</span>
      <button type="button" class="empty-create-btn" id="emptyCreateBtn">Crear primera nota</button>
    </div>
    <div class="editor-wrap">
      <div class="editor-title" id="editorTitle" contenteditable="true" data-placeholder="Sin título"></div>
      <span id="savedIndicator"></span>
      <div class="editor-body" id="editorBody" contenteditable="true" data-placeholder="Escribí algo…"></div>

    </div>
  </main>

  <!-- AI helper — floating bottom bar (shown on new note) -->
  <div class="ai-helper" id="aiHelper" role="complementary" aria-label="AI writing assistant">
    <p class="ai-helper-label">Start anywhere. I can help shape it.</p>
    <div class="ai-helper-pill">
      <textarea
        class="ai-helper-textarea"
        id="aiHelperInput"
        placeholder="Describe what you want to write…"
        rows="1"
        autocomplete="off"
        spellcheck="true"
        aria-label="AI writing prompt"
      ></textarea>
      <button type="button" class="ai-helper-send" id="aiHelperSend" aria-label="Generate">
        <span class="ai-helper-spinner"></span>
        <svg class="ai-helper-arrow" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Share panel -->
  <div class="share-backdrop" id="shareBackdrop"></div>
  <div class="share-panel" id="sharePanel">
    <button type="button" class="share-panel-close" id="shareClose" title="Cerrar">×</button>

    <div class="share-panel-section">
      <div class="share-section-label">Shared with</div>
      <div class="share-people-row">
        <div class="share-avatar">T</div>
        <div class="share-person-info">
          <div class="share-person-name">Toto</div>
          <div class="share-person-email" id="shareOwnerEmail">you@example.com</div>
        </div>
        <span class="share-access-chip">Owner</span>
      </div>
      <div class="share-invite-row">
        <input type="email" class="share-invite-input" id="shareInviteInput" placeholder="Invite by email…" autocomplete="off">
        <button type="button" class="share-invite-btn" id="shareInviteBtn">Invite</button>
      </div>
    </div>

    <div class="share-divider"></div>

    <div class="share-panel-section">
      <div class="share-section-label">Share link</div>
      <div class="share-link-row">
        <span class="share-link-url" id="shareLinkUrl">pages.app/note/—</span>
        <button type="button" class="share-link-copy" id="shareLinkCopy">Copy</button>
      </div>
    </div>

    <div class="share-divider"></div>

    <div class="share-panel-section">
      <div class="share-section-label">Publish to</div>
      <div class="share-social-grid">
        <!-- Substack -->
        <button type="button" class="share-social-btn" id="shareSubstack">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" rx="6" fill="#FF6719"/>
            <path d="M5 7.5h14v1.5H5V7.5zm0 3.5h14v1.5H5V11zm0 3.5v5.5l7-3.5 7 3.5V14.5H5z" fill="#fff"/>
          </svg>
          <span>Substack</span>
        </button>
        <!-- X / Twitter -->
        <button type="button" class="share-social-btn" id="shareTwitter">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" rx="6" fill="#000"/>
            <path d="M13.38 10.98 18.14 5.5h-1.13l-4.1 4.77L9.4 5.5H5.5l5.01 7.28L5.5 18.5h1.13l4.38-5.1 3.6 5.1H18.5l-5.12-7.52zm-1.55 1.8-.5-.72L6.93 6.34h1.73l3.24 4.64.5.72 4.2 6.01h-1.73l-3.44-4.93z" fill="#fff"/>
          </svg>
          <span>X</span>
        </button>
        <!-- LinkedIn -->
        <button type="button" class="share-social-btn" id="shareLinkedIn">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" rx="6" fill="#0A66C2"/>
            <path d="M7.5 9.5H5.5v9h2V9.5zm-1-1.5a1.25 1.25 0 1 0 0-2.5 1.25 1.25 0 0 0 0 2.5zm9 1.5c-1.38 0-2.3.65-2.7 1.3V9.5H10.8v9h2V13c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5.5h2V13c0-2.2-1.35-3.5-3.3-3.5z" fill="#fff"/>
          </svg>
          <span>LinkedIn</span>
        </button>
      </div>
    </div>
  </div>

  <div class="share-copied-toast" id="shareCopiedToast">Link copied!</div>

  <!-- Versions chip (hidden, kept for JS) -->
  <span id="versionsChip" style="display:none">
    <span id="versionsCount">0</span>
    <div id="versionsDropdown"></div>
  </span>

  <!-- Diff accept/reject buttons -->
  <div class="diff-actions" id="diffActions">
    <button type="button" class="diff-btn diff-btn-accept" id="diffAccept">✓ Accept</button>
    <button type="button" class="diff-btn diff-btn-reject" id="diffReject">✗ Reject</button>
  </div>

  <!-- Slash command menu -->
  <div class="slash-menu" id="slashMenu">
    <div class="slash-item" data-cmd="h1">
      <div class="slash-item-icon">H1</div>
      <div><div class="slash-item-label">Heading 1</div><div class="slash-item-desc">Large title</div></div>
    </div>
    <div class="slash-item" data-cmd="h2">
      <div class="slash-item-icon">H2</div>
      <div><div class="slash-item-label">Heading 2</div><div class="slash-item-desc">Section title</div></div>
    </div>
    <div class="slash-item" data-cmd="h3">
      <div class="slash-item-icon">H3</div>
      <div><div class="slash-item-label">Heading 3</div><div class="slash-item-desc">Sub-section</div></div>
    </div>
    <div class="slash-item" data-cmd="ul">
      <div class="slash-item-icon">•</div>
      <div><div class="slash-item-label">Bullet list</div><div class="slash-item-desc">Unordered list</div></div>
    </div>
    <div class="slash-item" data-cmd="ol">
      <div class="slash-item-icon">1.</div>
      <div><div class="slash-item-label">Numbered list</div><div class="slash-item-desc">Ordered list</div></div>
    </div>
    <div class="slash-item" data-cmd="quote">
      <div class="slash-item-icon">"</div>
      <div><div class="slash-item-label">Quote</div><div class="slash-item-desc">Block quote</div></div>
    </div>
    <div class="slash-item" data-cmd="divider">
      <div class="slash-item-icon">—</div>
      <div><div class="slash-item-label">Divider</div><div class="slash-item-desc">Horizontal rule</div></div>
    </div>
  </div>

  <!-- Word count -->
  <div class="word-count" id="wordCount"></div>

  <!-- Focus mode hint -->
  <div class="focus-hint" id="focusHint">Focus mode · mueve el mouse para salir</div>

  <!-- Quote paste toast -->
  <div class="quote-toast" id="quoteToast">
    ¿Convertir en cita?
    <button type="button" class="quote-toast-btn quote-toast-yes" id="quoteToastYes">Sí</button>
    <button type="button" class="quote-toast-btn quote-toast-no" id="quoteToastNo">No</button>
  </div>

  <div class="format-toolbar" id="formatToolbar">
    <button type="button" id="btnBold" title="Negrita">B</button>
    <button type="button" id="btnItalic" title="Cursiva">I</button>
    <button type="button" id="btnH1" title="Título 1">H1</button>
    <button type="button" id="btnH2" title="Título 2">H2</button>
    <button type="button" id="btnBulletList" title="Lista con viñetas">•</button>
    <div class="sep"></div>
    <button type="button" id="btnLink" title="Enlace">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
    </button>
  </div>

  <!-- Floating Format Toolbar (selection-based) -->
  <div class="fmt-bar" id="fmtBar" role="toolbar" aria-label="Text formatting">
    <button type="button" class="fmt-btn" data-cmd="bold" aria-label="Bold (⌘B)" title="Bold (⌘B)"><b>B</b></button>
    <button type="button" class="fmt-btn" data-cmd="italic" aria-label="Italic (⌘I)" title="Italic (⌘I)"><i style="font-style:italic">I</i></button>
    <button type="button" class="fmt-btn" data-cmd="underline" aria-label="Underline (⌘U)" title="Underline (⌘U)"><u>U</u></button>
    <div class="fmt-sep"></div>
    <button type="button" class="fmt-btn" data-cmd="link" aria-label="Link (⌘K)" title="Link (⌘K)">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
    </button>
    <button type="button" class="fmt-btn" data-cmd="removeFormat" aria-label="Clear formatting" title="Clear formatting">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M10 11v6M14 11v6M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"/></svg>
    </button>
    <div class="fmt-sep"></div>
    <button type="button" class="fmt-btn fmt-ai-btn" data-cmd="ai" aria-label="Edit with AI" title="Edit with AI">✦</button>
  </div>

  <!-- Link input panel (shown below fmt-bar) -->
  <div class="fmt-link-panel" id="fmtLinkPanel">
    <input type="url" class="fmt-link-input" id="fmtLinkInput" placeholder="https://…" autocomplete="off" aria-label="URL">
    <button type="button" class="fmt-link-apply" id="fmtLinkApply">Apply</button>
  </div>

  <!-- ═══ AI EDIT BAR (shown below selection, one-click quick actions) ═══ -->
  <div class="ai-edit-bar" id="aiEditBar" role="toolbar" aria-label="AI quick edit actions">
    <span class="ai-edit-bar-label">AI</span>
    <div class="ai-edit-sep"></div>
    <!-- Quick action buttons -->
    <button type="button" class="ai-edit-action-btn" data-edit-action="rewrite">Rewrite</button>
    <button type="button" class="ai-edit-action-btn" data-edit-action="shorter">Shorter</button>
    <button type="button" class="ai-edit-action-btn" data-edit-action="clearer">Clearer</button>
    <button type="button" class="ai-edit-action-btn" data-edit-action="fix">Fix</button>
    <div class="ai-edit-sep"></div>
    <!-- Tone dropdown -->
    <div class="ai-edit-dd-wrap" id="aiEditToneWrap">
      <button type="button" class="ai-edit-action-btn ai-edit-dd-trigger" id="aiEditToneBtn" aria-haspopup="true" aria-expanded="false">
        Tone
        <svg class="ai-edit-chevron" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div class="ai-edit-dd" id="aiEditToneDropdown" role="menu">
        <button type="button" class="ai-edit-dd-item" data-tone="Professional" role="menuitem">Professional</button>
        <button type="button" class="ai-edit-dd-item" data-tone="Casual"        role="menuitem">Casual</button>
        <button type="button" class="ai-edit-dd-item" data-tone="Strong"        role="menuitem">Strong</button>
        <button type="button" class="ai-edit-dd-item" data-tone="Friendly"      role="menuitem">Friendly</button>
      </div>
    </div>
    <!-- More dropdown -->
    <div class="ai-edit-dd-wrap" id="aiEditMoreWrap">
      <button type="button" class="ai-edit-action-btn ai-edit-dd-trigger" id="aiEditMoreBtn" aria-haspopup="true" aria-expanded="false">
        More
        <svg class="ai-edit-chevron" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div class="ai-edit-dd" id="aiEditMoreDropdown" role="menu">
        <button type="button" class="ai-edit-dd-item" data-edit-action="expand"  role="menuitem">Expand</button>
        <button type="button" class="ai-edit-dd-item" data-edit-action="bullets" role="menuitem">Convert to bullets</button>
      </div>
    </div>
    <div class="ai-edit-sep"></div>
    <!-- Dismiss -->
    <button type="button" class="ai-edit-close-btn" id="aiEditClose" aria-label="Dismiss AI edit bar">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>

  <!-- ═══ AI EDIT RESULTS PANEL (alternatives, shown below the edit bar) ═══ -->
  <div class="ai-edit-results" id="aiEditResults" role="listbox" aria-label="AI edit alternatives">
    <!-- Loading -->
    <div class="ai-edit-loading-row" id="aiEditLoadingRow">
      <span class="ai-edit-result-spinner"></span>
      <span>Generating alternatives…</span>
    </div>
    <!-- Alternatives list (populated by JS) -->
    <div class="ai-edit-alts-list" id="aiEditAltsList"></div>
    <!-- Error -->
    <div class="ai-edit-error-row" id="aiEditErrorRow">
      <span id="aiEditErrorMsg">Couldn't generate alternatives.</span>
      <button type="button" class="ai-edit-retry-btn" id="aiEditRetryBtn">Try again</button>
    </div>
    <!-- Footer actions -->
    <div class="ai-edit-results-footer" id="aiEditFooter">
      <button type="button" class="ai-edit-apply ai-edit-apply-replace" id="aiEditApplyReplace">Replace selection</button>
      <button type="button" class="ai-edit-apply ai-edit-apply-insert"  id="aiEditApplyInsert">Insert below</button>
      <button type="button" class="ai-edit-apply ai-edit-apply-cancel"  id="aiEditApplyCancel">Cancel</button>
    </div>
  </div>

  <!-- Block paragraph handle (drag + type selector) -->
  <div id="paraHandle" aria-label="Block handle — drag to reorder, click for type" title="Drag to reorder · click for type">
    <svg width="8" height="14" viewBox="0 0 8 14" fill="currentColor" aria-hidden="true">
      <circle cx="2" cy="2" r="1.5"/><circle cx="6" cy="2" r="1.5"/>
      <circle cx="2" cy="7" r="1.5"/><circle cx="6" cy="7" r="1.5"/>
      <circle cx="2" cy="12" r="1.5"/><circle cx="6" cy="12" r="1.5"/>
    </svg>
  </div>

  <!-- Block type context menu -->
  <div id="blockTypeMenu" role="menu" aria-label="Block type">
    <div class="btype-item" data-btype="p"          role="menuitem"><span class="btype-icon">¶</span>Text</div>
    <div class="btype-item" data-btype="h1"         role="menuitem"><span class="btype-icon">H1</span>Heading 1</div>
    <div class="btype-item" data-btype="h2"         role="menuitem"><span class="btype-icon">H2</span>Heading 2</div>
    <div class="btype-item" data-btype="h3"         role="menuitem"><span class="btype-icon">H3</span>Heading 3</div>
    <div class="btype-item" data-btype="ul"         role="menuitem"><span class="btype-icon">•</span>Bullet list</div>
    <div class="btype-item" data-btype="ol"         role="menuitem"><span class="btype-icon">1.</span>Numbered</div>
    <div class="btype-item" data-btype="blockquote" role="menuitem"><span class="btype-icon">"</span>Quote</div>
  </div>

  <!-- Drag insertion indicator line -->
  <div id="dragInsertLine" aria-hidden="true"></div>

  <!-- Drag-to-delete zone (shown during block drag) -->
  <div id="dragDeleteZone" aria-hidden="true">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
    Drop here to delete
  </div>

  <div class="floating-chat-backdrop" id="floatingChatBackdrop"></div>
  <div class="floating-chat" id="floatingChat">
    <input type="text" class="floating-chat-input" id="floatingChatInput" placeholder="Edit selection…" autocomplete="off">
    <span class="floating-chat-sep"></span>
    <div class="floating-chat-mood-wrap" id="floatingChatMoodWrap">
      <button type="button" class="floating-chat-mood-btn" id="floatingChatMoodBtn">Mood
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <div class="floating-chat-mood-dropdown" id="floatingChatMoodDropdown">
        <button type="button" class="floating-chat-mood-option" data-mood="smarter">Smarter</button>
        <button type="button" class="floating-chat-mood-option" data-mood="powerful">More powerful</button>
        <button type="button" class="floating-chat-mood-option" data-mood="new">Try something new</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // ——— Share panel ———
    const shareBackdrop = document.getElementById('shareBackdrop');
    const sharePanel = document.getElementById('sharePanel');
    const shareClose = document.getElementById('shareClose');
    const shareInviteInput = document.getElementById('shareInviteInput');
    const shareInviteBtn = document.getElementById('shareInviteBtn');
    const shareLinkUrl = document.getElementById('shareLinkUrl');
    const shareLinkCopy = document.getElementById('shareLinkCopy');
    const shareCopiedToast = document.getElementById('shareCopiedToast');

    const MOCK_SHARE_LINK = 'pages.app/note/' + Math.random().toString(36).slice(2, 8);
    shareLinkUrl.textContent = MOCK_SHARE_LINK;

    function openSharePanel() {
      shareBackdrop.classList.add('visible');
      sharePanel.classList.add('visible');
    }

    function closeSharePanel() {
      shareBackdrop.classList.remove('visible');
      sharePanel.classList.remove('visible');
    }

    document.querySelector('.btn-share').addEventListener('click', openSharePanel);
    shareClose.addEventListener('click', closeSharePanel);
    shareBackdrop.addEventListener('click', closeSharePanel);

    shareInviteBtn.addEventListener('click', () => {
      const val = shareInviteInput.value.trim();
      if (!val) { shareInviteInput.focus(); return; }
      shareInviteInput.value = '';
      showToast('Invite sent to ' + val);
    });

    shareInviteInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') shareInviteBtn.click();
    });

    shareLinkCopy.addEventListener('click', () => {
      navigator.clipboard.writeText('https://' + MOCK_SHARE_LINK).catch(() => {});
      showToast('Link copied!');
    });

    let toastTimeout = null;
    function showToast(msg) {
      shareCopiedToast.textContent = msg;
      shareCopiedToast.classList.add('visible');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => shareCopiedToast.classList.remove('visible'), 2200);
    }

    // ——— Sidebar toggle ———
    const btnToggleSidebar = document.getElementById('btnToggleSidebar');
    const sidebarRevealBtn = document.getElementById('sidebarRevealBtn');

    function hideSidebar() {
      document.body.classList.add('sidebar-hidden');
    }
    function revealSidebar() {
      document.body.classList.remove('sidebar-hidden');
    }

    btnToggleSidebar.addEventListener('click', hideSidebar);
    sidebarRevealBtn.addEventListener('click', revealSidebar);

    // Social share listeners wired after getCurrentDoc is defined (see bottom of script)

    // ——— Supabase config ———
    const SB_URL = 'https://kihxztxxpfwmhltangih.supabase.co';
    const SB_KEY = 'sb_publishable_fPkLRpscUpvTP7h-ogA9yA_uOnD4xVH';
    const SB_HEADERS = {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    };
    const ACTIVE_KEY = 'pages-active-id';

    // ——— Supabase Auth client ———
    const sbClient = window.supabase
      ? window.supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession: true, detectSessionInUrl: true } })
      : null;

    async function sbFetch(path, options = {}) {
      const res = await fetch(SB_URL + path, {
        ...options,
        headers: { ...SB_HEADERS, ...(options.headers || {}) }
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(err);
      }
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    // ——— App ———
    let documents = [];   // local cache; shape: { id, title, body, updatedAt }
    let currentId = null;
    let currentUserId = null;   // set after auth; used to scope note inserts to owner
    let saveTimeout = null;
    const SAVE_DELAY = 800;
    const pendingDeletes = {};

    const editorTitle = document.getElementById('editorTitle');
    const editorBody = document.getElementById('editorBody');
    const docListEl = document.getElementById('docList');
    const formatToolbar = document.getElementById('formatToolbar');
    const savedIndicatorEl = document.getElementById('savedIndicator');
    const searchEmptyEl = document.getElementById('searchEmpty');
    const emptyStateEl = document.getElementById('emptyState');
    const editorWrapEl = document.querySelector('.editor-wrap');
    let savedIndicatorTimer = null;

    // Convert Supabase row → local doc shape
    function rowToDoc(row) {
      return {
        id: row.id,
        title: row.title || '',
        body: row.content || '<p></p>',
        updatedAt: row.updated_at
      };
    }

    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || '').trim();
    }

    function getPreview(doc) {
      const text = stripHtml(doc.body || '');
      if (!text) return null;
      return text.split(/\s+/).slice(0, 6).join(' ');
    }

    // ——— Supabase CRUD ———
    async function loadDocuments() {
      setLoadingState(true);
      try {
        const rows = await sbFetch('/rest/v1/notes?select=*&order=updated_at.desc');
        documents = (rows || []).map(rowToDoc);
        if (documents.length === 0) {
          // Create welcome note on first run
          await createDoc('Bienvenido', '<p>Este es tu espacio para escribir. Usá la barra lateral para crear nuevos documentos o cambiar entre ellos.</p><p>Todo se guarda automáticamente en la nube.</p>');
          return;
        }
        const savedId = localStorage.getItem(ACTIVE_KEY);
        const exists = savedId && documents.find(d => d.id === savedId);
        currentId = exists ? savedId : documents[0].id;
        showDoc(currentId);
        renderDocList();
      } catch (err) {
        showSyncError('No se pudo cargar las notas. Revisá tu conexión.');
        console.error('loadDocuments:', err);
      } finally {
        setLoadingState(false);
      }
    }

    async function createDoc(defaultTitle = '', defaultBody = '<p></p>') {
      try {
        // user_id is required by the RLS INSERT policy (user_id = auth.uid())
        const payload = { title: defaultTitle, content: defaultBody };
        if (currentUserId) payload.user_id = currentUserId;
        const rows = await sbFetch('/rest/v1/notes', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const doc = rowToDoc(Array.isArray(rows) ? rows[0] : rows);
        documents.unshift(doc);
        currentId = doc.id;
        localStorage.setItem(ACTIVE_KEY, doc.id);
        showDoc(doc.id);
        renderDocList();
        if (!defaultTitle) editorTitle.focus();
      } catch (err) {
        console.error('createDoc:', err);
        showSyncError('No se pudo crear la nota.');
      }
    }

    async function saveCurrentDoc() {
      const doc = getCurrentDoc();
      if (!doc) return;
      doc.title = editorTitle.textContent.trim() || '';
      doc.body = editorBody.innerHTML;
      doc.updatedAt = new Date().toISOString();
      try {
        await sbFetch('/rest/v1/notes?id=eq.' + doc.id, {
          method: 'PATCH',
          body: JSON.stringify({ title: doc.title, content: doc.body, updated_at: doc.updatedAt })
        });
        showSavedIndicator();
        patchDocInList(doc);
      } catch (err) {
        console.error('saveCurrentDoc:', err);
        showSyncError('No se guardó. Revisá tu conexión.');
      }
    }

    async function deleteDoc(id, e) {
      if (e) e.stopPropagation();
      if (documents.length <= 1) return;

      const doc = documents.find(d => d.id === id);
      const hasContent = doc && (stripHtml(doc.body || '').length > 0 || (doc.title || '').trim().length > 0);
      const el = docListEl.querySelector(`.doc-item[data-id="${id}"]`);

      if (hasContent && !pendingDeletes[id]) {
        if (el) {
          el.classList.add('shake');
          el.addEventListener('animationend', () => el.classList.remove('shake'), { once: true });
        }
        pendingDeletes[id] = setTimeout(() => { delete pendingDeletes[id]; }, 2000);
        return;
      }

      if (pendingDeletes[id]) {
        clearTimeout(pendingDeletes[id]);
        delete pendingDeletes[id];
      }

      const idx = documents.findIndex(d => d.id === id);
      documents = documents.filter(d => d.id !== id);

      if (currentId === id) {
        const nextDoc = documents[Math.min(idx, documents.length - 1)];
        currentId = nextDoc ? nextDoc.id : null;
        if (currentId) {
          showDoc(currentId);
          localStorage.setItem(ACTIVE_KEY, currentId);
        } else {
          await createDoc();
          return;
        }
      }
      renderDocList();

      // Fire-and-forget delete to Supabase
      sbFetch('/rest/v1/notes?id=eq.' + id, { method: 'DELETE' }).catch(err => {
        console.error('deleteDoc:', err);
      });
    }

    function getCurrentDoc() {
      return documents.find(d => d.id === currentId);
    }

    function switchDoc(id) {
      currentId = id;
      localStorage.setItem(ACTIVE_KEY, id);
      showDoc(id);
      renderDocList();
    }

    function showDoc(id) {
      const doc = documents.find(d => d.id === id);
      if (!doc) return;
      editorTitle.textContent = doc.title || '';
      editorBody.innerHTML = doc.body || '<p></p>';
      updateWordCount();
      updateVersionsChip();
      updateEmptyState();
    }

    function updateEmptyState() {
      const hasDoc = documents.length > 0 && currentId;
      emptyStateEl.classList.toggle('visible', !hasDoc);
      editorWrapEl.style.display = hasDoc ? '' : 'none';
    }

    function showSavedIndicator() {
      if (!savedIndicatorEl) return;
      savedIndicatorEl.textContent = '✓ Guardado';
      savedIndicatorEl.style.color = '#4caf50';
      savedIndicatorEl.classList.add('visible');
      clearTimeout(savedIndicatorTimer);
      savedIndicatorTimer = setTimeout(() => savedIndicatorEl.classList.remove('visible'), 1500);
    }

    function showSyncError(msg) {
      if (!savedIndicatorEl) return;
      savedIndicatorEl.textContent = '⚠ ' + msg;
      savedIndicatorEl.style.color = '#e57373';
      savedIndicatorEl.classList.add('visible');
      clearTimeout(savedIndicatorTimer);
      savedIndicatorTimer = setTimeout(() => savedIndicatorEl.classList.remove('visible'), 3000);
    }

    function setLoadingState(on) {
      docListEl.style.opacity = on ? '0.4' : '';
    }

    function renderDocList() {
      const sorted = [...documents].sort((a, b) =>
        new Date(b.updatedAt) - new Date(a.updatedAt)
      );
      const canDelete = documents.length > 1;
      const svgIcon = `<svg class="doc-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`;

      docListEl.innerHTML = sorted.map(doc => {
        const hasTitle = (doc.title || '').trim().length > 0;
        const titleText = hasTitle ? escapeHtml(doc.title) : 'Sin título';
        const titleClass = hasTitle ? 'doc-item-title' : 'doc-item-title untitled';
        const isActive = doc.id === currentId;
        const preview = getPreview(doc);
        const previewHtml = preview
          ? `<span class="doc-item-preview">${escapeHtml(preview)}</span>`
          : `<span class="doc-item-preview empty">Sin contenido aún</span>`;
        const deleteBtn = canDelete
          ? `<span class="doc-item-actions"><button type="button" class="btn-delete-doc" data-id="${doc.id}" title="Eliminar">×</button></span>`
          : '';
        return `<div class="doc-item${isActive ? ' active' : ''}" data-id="${doc.id}">${svgIcon}<div class="doc-item-content"><span class="${titleClass}">${titleText}</span>${previewHtml}</div>${deleteBtn}</div>`;
      }).join('');

      updateSearchFilter();
    }

    function updateSearchFilter() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      let visibleCount = 0;
      docListEl.querySelectorAll('.doc-item').forEach(item => {
        const title = (item.querySelector('.doc-item-title').textContent || '').toLowerCase();
        const preview = (item.querySelector('.doc-item-preview') ? item.querySelector('.doc-item-preview').textContent : '').toLowerCase();
        const matches = q === '' || title.includes(q) || preview.includes(q);
        item.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });
      if (searchEmptyEl) searchEmptyEl.classList.toggle('visible', q !== '' && visibleCount === 0);
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function patchDocInList(doc) {
      const sorted = [...documents].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      const firstId = sorted[0] && sorted[0].id;
      if (firstId === doc.id && docListEl.firstElementChild && docListEl.firstElementChild.dataset.id === doc.id) {
        const el = docListEl.querySelector(`.doc-item[data-id="${doc.id}"]`);
        if (el) {
          const hasTitle = doc.title.trim().length > 0;
          const titleEl = el.querySelector('.doc-item-title');
          if (titleEl) {
            titleEl.textContent = hasTitle ? doc.title : 'Sin título';
            titleEl.className = hasTitle ? 'doc-item-title' : 'doc-item-title untitled';
          }
          const previewEl = el.querySelector('.doc-item-preview');
          if (previewEl) {
            const preview = getPreview(doc);
            previewEl.textContent = preview || 'Sin contenido aún';
            previewEl.className = preview ? 'doc-item-preview' : 'doc-item-preview empty';
          }
        }
      } else {
        renderDocList();
      }
    }

    function scheduleSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveCurrentDoc, SAVE_DELAY);
    }

    // Event delegation for doc list clicks — ONE listener, no leaks
    docListEl.addEventListener('click', (e) => {
      const deleteBtn = e.target.closest('.btn-delete-doc');
      if (deleteBtn) {
        e.stopPropagation();
        deleteDoc(deleteBtn.dataset.id, e);
        return;
      }
      const item = e.target.closest('.doc-item');
      if (item) {
        switchDoc(item.dataset.id);
      }
    });

    document.getElementById('btnNewNote').addEventListener('click', openNewNote);
    document.getElementById('emptyCreateBtn').addEventListener('click', openNewNote);

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', updateSearchFilter);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchInput.value = '';
        updateSearchFilter();
        searchInput.blur();
      }
    });

    editorTitle.addEventListener('input', scheduleSave);
    editorTitle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        editorBody.focus();
      } else if (e.key === 'Tab') {
        e.preventDefault();
        editorBody.focus();
      }
    });

    editorBody.addEventListener('input', scheduleSave);

    // ——— Floating chat state ———
    let savedSelectionRange = null;
    let highlightMark = null;
    let isDragging = false;

    const floatingChat = document.getElementById('floatingChat');
    const floatingChatBackdrop = document.getElementById('floatingChatBackdrop');
    const floatingChatInput = document.getElementById('floatingChatInput');
    const floatingChatMoodBtn = document.getElementById('floatingChatMoodBtn');
    const floatingChatMoodDropdown = document.getElementById('floatingChatMoodDropdown');

    const MOOD_INSTRUCTIONS = {
      smarter: 'Make this sound smarter',
      powerful: 'Make this more powerful',
      new: 'Try something new'
    };

    function applySelectionHighlight(range) {
      removeSelectionHighlight();
      if (!range || range.collapsed) return;
      try {
        const mark = document.createElement('mark');
        mark.className = 'selection-highlight';
        mark.id = '__sel_highlight__';
        range.cloneRange().surroundContents(mark);
        highlightMark = mark;
      } catch (_) {
        // Multi-element selection: can't wrap, skip highlight
        highlightMark = null;
      }
    }

    function removeSelectionHighlight() {
      if (highlightMark && highlightMark.parentNode) {
        const parent = highlightMark.parentNode;
        while (highlightMark.firstChild) parent.insertBefore(highlightMark.firstChild, highlightMark);
        parent.removeChild(highlightMark);
        parent.normalize();
      }
      highlightMark = null;
    }

    function positionChat(selRect) {
      // Force layout so we get real dimensions
      floatingChat.style.visibility = 'hidden';
      floatingChat.style.display = 'flex';
      const cw = floatingChat.offsetWidth;
      const ch = floatingChat.offsetHeight;
      floatingChat.style.visibility = '';
      floatingChat.style.display = '';

      const GAP = 10;
      const MARGIN = 12;
      const viewW = window.innerWidth;
      const viewH = window.innerHeight;

      // Center horizontally on selection, clamped to viewport
      let left = selRect.left + selRect.width / 2 - cw / 2;
      left = Math.max(MARGIN, Math.min(left, viewW - cw - MARGIN));

      // Arrow offset relative to chat left
      const arrowLeft = (selRect.left + selRect.width / 2) - left;
      const arrowPct = Math.max(10, Math.min(90, (arrowLeft / cw) * 100));

      // Try below, then above
      let top, arrowDir;
      const belowTop = selRect.bottom + GAP;
      const aboveTop = selRect.top - ch - GAP;

      if (belowTop + ch < viewH - MARGIN) {
        top = belowTop;
        arrowDir = 'up'; // arrow points up toward selection
      } else if (aboveTop > MARGIN) {
        top = aboveTop;
        arrowDir = 'down'; // arrow points down toward selection
      } else {
        top = Math.max(MARGIN, belowTop);
        arrowDir = 'up';
      }

      floatingChat.style.left = left + 'px';
      floatingChat.style.top = top + 'px';
      floatingChat.classList.toggle('arrow-up', arrowDir === 'up');
      floatingChat.classList.toggle('arrow-down', arrowDir === 'down');

      // Nudge arrow tip to point at center of selection
      const arrowEl = floatingChat;
      arrowEl.style.setProperty('--arrow-left', arrowPct + '%');
    }

    function tryOpenChat() {
      if (floatingChat.classList.contains('visible')) return;
      const sel = window.getSelection();
      if (!sel || sel.isCollapsed || !sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if (!editorBody.contains(sel.anchorNode) && !editorBody.contains(sel.focusNode)) return;
      const selRect = range.getBoundingClientRect();
      if (!selRect || selRect.width === 0) return;

      savedSelectionRange = range.cloneRange();
      applySelectionHighlight(savedSelectionRange);
      sel.removeAllRanges(); // Clear OS selection, highlight mark takes over

      positionChat(selRect);

      floatingChatBackdrop.classList.add('visible');
      floatingChat.classList.add('visible');
      floatingChatInput.value = '';
      setTimeout(() => floatingChatInput.focus(), 30);
    }

    function closeFloatingChat() {
      removeSelectionHighlight();
      floatingChatBackdrop.classList.remove('visible');
      floatingChat.classList.remove('visible');
      floatingChatMoodDropdown.classList.remove('visible');
      savedSelectionRange = null;
    }

    function replaceSelectionWithText(text) {
      removeSelectionHighlight();
      if (!savedSelectionRange) return;
      editorBody.focus();
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedSelectionRange);
      document.execCommand('insertText', false, text);
      scheduleSave();
    }

    // ——— Selection triggers ———

    // Drag: show format bar on mouseup after dragging within editor
    editorBody.addEventListener('mousedown', () => { isDragging = true; });
    document.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      isDragging = false;
      // Small delay to let browser finalize selection
      setTimeout(checkAndShowFmtBar, 10);
    });

    // Double-click: word selection → format bar
    editorBody.addEventListener('dblclick', () => {
      setTimeout(checkAndShowFmtBar, 10);
    });

    // Triple-click: paragraph selection → format bar
    editorBody.addEventListener('click', (e) => {
      if (e.detail === 3) {
        setTimeout(checkAndShowFmtBar, 10);
      }
    });

    // Ctrl/Cmd+Z → undo; Ctrl/Cmd+Shift+Z or Ctrl+Y → redo
    function handleUndoRedo(e) {
      if (!(e.metaKey || e.ctrlKey)) return;
      if (e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        document.execCommand('undo');
      } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
        e.preventDefault();
        document.execCommand('redo');
      }
    }
    editorBody.addEventListener('keydown', handleUndoRedo);
    editorTitle.addEventListener('keydown', handleUndoRedo);

    // Keyboard selection (shift+arrow etc.) → format bar
    editorBody.addEventListener('keyup', (e) => {
      if (e.shiftKey || e.key === 'a' && (e.metaKey || e.ctrlKey)) {
        checkAndShowFmtBar();
      }
    });

    // Close on backdrop click
    floatingChatBackdrop.addEventListener('click', (e) => {
      if (e.target === floatingChatBackdrop) closeFloatingChat();
    });

    // Keep chat open when clicking inside it
    floatingChat.addEventListener('mousedown', (e) => e.stopPropagation());

    // Close when clicking outside editor+chat
    function execFormat(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editorBody.focus();
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && floatingChat.classList.contains('visible')) {
        closeFloatingChat();
      }
    });
    floatingChatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = floatingChatInput.value.trim();
        const mockResult = value ? `[revisado] ${value}` : '[revisado] ' + (savedSelectionRange ? savedSelectionRange.toString() : '');
        showInlineDiff(mockResult);
        closeFloatingChat();
      }
    });
    floatingChatMoodBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      floatingChatMoodDropdown.classList.toggle('visible');
    });
    floatingChatInput.addEventListener('click', () => floatingChatMoodDropdown.classList.remove('visible'));
    floatingChatMoodDropdown.querySelectorAll('.floating-chat-mood-option').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const mood = btn.dataset.mood;
        floatingChatInput.value = MOOD_INSTRUCTIONS[mood] || '';
        floatingChatMoodDropdown.classList.remove('visible');
        floatingChatInput.focus();
      });
    });
    document.addEventListener('click', (e) => {
      if (!document.getElementById('floatingChatMoodWrap').contains(e.target)) {
        floatingChatMoodDropdown.classList.remove('visible');
      }
    });

    // ═══════════════════════════════════════════════
    // 1. INLINE DIFF REVIEW
    // ═══════════════════════════════════════════════
    const diffActions = document.getElementById('diffActions');
    const diffAccept = document.getElementById('diffAccept');
    const diffReject = document.getElementById('diffReject');
    let diffOldNode = null;
    let diffNewNode = null;
    let diffOriginalRange = null;

    function showInlineDiff(newText) {
      if (!savedSelectionRange) return;
      const range = savedSelectionRange.cloneRange();
      diffOriginalRange = range.cloneRange();
      const originalText = range.toString();

      // Build old span (red strikethrough)
      const oldSpan = document.createElement('span');
      oldSpan.className = 'diff-old';
      oldSpan.textContent = originalText;

      // Build new span (green)
      const newSpan = document.createElement('span');
      newSpan.className = 'diff-new';
      newSpan.textContent = newText;

      // Replace selection with [old][new]
      removeSelectionHighlight();
      editorBody.focus();
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);

      // Delete selected content, insert spans
      range.deleteContents();
      const frag = document.createDocumentFragment();
      frag.appendChild(oldSpan);
      frag.appendChild(document.createTextNode(' '));
      frag.appendChild(newSpan);
      range.insertNode(frag);

      diffOldNode = oldSpan;
      diffNewNode = newSpan;
      scheduleSave();

      // Position diff actions below the new span
      requestAnimationFrame(() => {
        const rect = newSpan.getBoundingClientRect();
        diffActions.style.left = rect.left + 'px';
        diffActions.style.top = (rect.bottom + 8) + 'px';
        diffActions.classList.add('visible');
      });
    }

    function acceptDiff() {
      if (!diffNewNode) return;
      const parent = diffNewNode.parentNode;
      const text = document.createTextNode(diffNewNode.textContent);
      // Remove old span, space, new span — insert plain text
      if (diffOldNode && diffOldNode.parentNode) {
        diffOldNode.parentNode.removeChild(diffOldNode);
      }
      // remove the space text node between them if present
      const prev = diffNewNode.previousSibling;
      if (prev && prev.nodeType === 3 && prev.textContent === ' ') prev.parentNode.removeChild(prev);
      parent.replaceChild(text, diffNewNode);
      parent.normalize();
      cleanupDiff();
      scheduleSave();
    }

    function rejectDiff() {
      if (!diffOldNode) return;
      const parent = diffOldNode.parentNode;
      const text = document.createTextNode(diffOldNode.textContent);
      if (diffNewNode && diffNewNode.parentNode) diffNewNode.parentNode.removeChild(diffNewNode);
      const spacer = diffOldNode.nextSibling;
      if (spacer && spacer.nodeType === 3 && spacer.textContent === ' ') spacer.parentNode.removeChild(spacer);
      parent.replaceChild(text, diffOldNode);
      parent.normalize();
      cleanupDiff();
      scheduleSave();
    }

    function cleanupDiff() {
      diffOldNode = null;
      diffNewNode = null;
      diffOriginalRange = null;
      diffActions.classList.remove('visible');
    }

    diffAccept.addEventListener('click', acceptDiff);
    diffReject.addEventListener('click', rejectDiff);
    // Escape also rejects
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && diffActions.classList.contains('visible')) {
        rejectDiff();
      }
    });

    // ═══════════════════════════════════════════════
    // 2. FOCUS MODE
    // ═══════════════════════════════════════════════
    const focusHint = document.getElementById('focusHint');
    let focusModeTimer = null;
    let focusModeActive = false;
    let focusHintTimer = null;
    let hasTyped = false;

    function enterFocusMode() {
      if (focusModeActive) return;
      focusModeActive = true;
      document.body.classList.add('focus-mode');
      focusHint.classList.add('visible');
      clearTimeout(focusHintTimer);
      focusHintTimer = setTimeout(() => focusHint.classList.remove('visible'), 2000);
    }

    function exitFocusMode() {
      if (!focusModeActive) return;
      focusModeActive = false;
      document.body.classList.remove('focus-mode');
      focusHint.classList.remove('visible');
      clearTimeout(focusModeTimer);
    }

    editorBody.addEventListener('input', () => {
      hasTyped = true;
      if (!focusModeActive) {
        clearTimeout(focusModeTimer);
        focusModeTimer = setTimeout(enterFocusMode, 1500);
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (!focusModeActive) {
        clearTimeout(focusModeTimer);
        if (hasTyped) {
          focusModeTimer = setTimeout(enterFocusMode, 1500);
        }
        return;
      }
      // Exit focus mode when mouse near top or left edges
      if (e.clientY < 60 || e.clientX < 200) {
        exitFocusMode();
      }
    });

    // ═══════════════════════════════════════════════
    // 3. SLASH COMMANDS
    // ═══════════════════════════════════════════════
    const slashMenu = document.getElementById('slashMenu');
    const slashItems = slashMenu.querySelectorAll('.slash-item');
    let slashActiveIndex = -1;
    let slashTargetNode = null;

    function openSlashMenu(caretRect) {
      slashActiveIndex = 0;
      slashItems.forEach((it, i) => it.classList.toggle('active', i === 0));
      slashMenu.style.left = caretRect.left + 'px';
      slashMenu.style.top = (caretRect.bottom + 6) + 'px';
      slashMenu.classList.add('visible');
    }

    function closeSlashMenu() {
      slashMenu.classList.remove('visible');
      slashActiveIndex = -1;
    }

    function applySlashCmd(cmd) {
      closeSlashMenu();
      editorBody.focus();

      // Remove the "/" using a Range so the cursor stays in the block
      if (slashTargetNode) {
        const text = slashTargetNode.textContent;
        const slashIdx = text.lastIndexOf('/');
        if (slashIdx !== -1) {
          const range = document.createRange();
          range.setStart(slashTargetNode, slashIdx);
          range.setEnd(slashTargetNode, slashIdx + 1);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          document.execCommand('delete', false);
        }
      }

      if (cmd === 'h1') {
        document.execCommand('formatBlock', false, 'h1');
      } else if (cmd === 'h2') {
        document.execCommand('formatBlock', false, 'h2');
      } else if (cmd === 'h3') {
        document.execCommand('formatBlock', false, 'h3');
      } else if (cmd === 'ul') {
        document.execCommand('insertUnorderedList');
      } else if (cmd === 'ol') {
        document.execCommand('insertOrderedList');
      } else if (cmd === 'quote') {
        document.execCommand('formatBlock', false, 'blockquote');
      } else if (cmd === 'divider') {
        document.execCommand('insertHTML', false, '<hr><p></p>');
      }
      scheduleSave();
    }

    editorBody.addEventListener('keydown', (e) => {
      if (slashMenu.classList.contains('visible')) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          slashActiveIndex = (slashActiveIndex + 1) % slashItems.length;
          slashItems.forEach((it, i) => it.classList.toggle('active', i === slashActiveIndex));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          slashActiveIndex = (slashActiveIndex - 1 + slashItems.length) % slashItems.length;
          slashItems.forEach((it, i) => it.classList.toggle('active', i === slashActiveIndex));
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const active = slashItems[slashActiveIndex];
          if (active) applySlashCmd(active.dataset.cmd);
        } else if (e.key === 'Escape') {
          closeSlashMenu();
        }
        return;
      }
    });

    editorBody.addEventListener('input', () => {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const node = range.startContainer;
      if (node.nodeType !== 3) return; // text node only
      const text = node.textContent;
      const offset = range.startOffset;
      // Check if "/" is at start of block (nothing or only whitespace before)
      const beforeSlash = text.slice(0, offset);
      if (beforeSlash === '/') {
        slashTargetNode = node;
        let caretRect = range.getBoundingClientRect();
        // Fallback: if rect is zero, try getting the parent element rect
        if (!caretRect || caretRect.width === 0) {
          const parentEl = node.parentElement;
          if (parentEl) caretRect = parentEl.getBoundingClientRect();
        }
        openSlashMenu(caretRect);
      } else if (!beforeSlash.endsWith('/')) {
        closeSlashMenu();
      }
    });

    slashItems.forEach(item => {
      item.addEventListener('mousedown', (e) => {
        e.preventDefault(); // prevent blur
        applySlashCmd(item.dataset.cmd);
      });
    });

    document.addEventListener('click', (e) => {
      if (!slashMenu.contains(e.target)) closeSlashMenu();
    });

    // ═══════════════════════════════════════════════
    // 4. WORD COUNT
    // ═══════════════════════════════════════════════
    const wordCountEl = document.getElementById('wordCount');

    function updateWordCount() {
      const text = editorBody.innerText || '';
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      if (words === 0) {
        wordCountEl.classList.remove('visible');
      } else {
        const mins = Math.max(1, Math.ceil(words / 200));
        wordCountEl.textContent = `${words} palabras · ${mins} min lectura`;
        wordCountEl.classList.add('visible');
      }
    }

    editorBody.addEventListener('input', updateWordCount);

    // ═══════════════════════════════════════════════
    // 5. AUTO VERSIONS
    // ═══════════════════════════════════════════════
    const VERSIONS_KEY = 'pages-versions';
    const VERSION_IDLE = 5 * 60 * 1000; // 5 min
    const MAX_VERSIONS = 10;
    let versionTimer = null;
    const versionsChip = document.getElementById('versionsChip');
    const versionsDropdown = document.getElementById('versionsDropdown');
    const versionsCountEl = document.getElementById('versionsCount');

    function getVersions(docId) {
      try {
        const all = JSON.parse(localStorage.getItem(VERSIONS_KEY) || '{}');
        return all[docId] || [];
      } catch { return []; }
    }

    function saveVersion(docId, title, body) {
      try {
        const all = JSON.parse(localStorage.getItem(VERSIONS_KEY) || '{}');
        const list = all[docId] || [];
        list.unshift({ ts: Date.now(), title, body });
        if (list.length > MAX_VERSIONS) list.length = MAX_VERSIONS;
        all[docId] = list;
        localStorage.setItem(VERSIONS_KEY, JSON.stringify(all));
        updateVersionsChip();
      } catch {}
    }

    function relativeTime(ts) {
      const diff = Date.now() - ts;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'hace un momento';
      if (mins < 60) return `hace ${mins} min`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `hace ${hrs}h`;
      return `hace ${Math.floor(hrs / 24)}d`;
    }

    function updateVersionsChip() {
      if (!currentId) return;
      const versions = getVersions(currentId);
      versionsCountEl.textContent = versions.length;
      versionsChip.style.display = versions.length === 0 ? 'none' : '';
    }

    function openVersionsDropdown() {
      if (!currentId) return;
      const versions = getVersions(currentId);
      if (!versions.length) return;
      versionsDropdown.innerHTML = versions.map((v, i) => `
        <button type="button" class="version-item" data-index="${i}">
          <span>${v.title || 'Sin título'}</span>
          <span class="version-item-time">${relativeTime(v.ts)}</span>
        </button>
      `).join('');
      versionsDropdown.querySelectorAll('.version-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const v = versions[parseInt(btn.dataset.index)];
          if (!v) return;
          // Fade out, swap, fade in
          editorBody.style.transition = 'opacity 0.2s ease';
          editorBody.style.opacity = '0';
          setTimeout(() => {
            editorBody.innerHTML = v.body;
            editorTitle.textContent = v.title;
            editorBody.style.opacity = '1';
            updateCurrentDoc();
            updateWordCount();
          }, 200);
          versionsDropdown.classList.remove('visible');
        });
      });
      versionsDropdown.classList.add('visible');
    }

    versionsChip.addEventListener('click', (e) => {
      e.stopPropagation();
      if (versionsDropdown.classList.contains('visible')) {
        versionsDropdown.classList.remove('visible');
      } else {
        openVersionsDropdown();
      }
    });

    document.addEventListener('click', (e) => {
      if (!versionsChip.contains(e.target)) versionsDropdown.classList.remove('visible');
    });

    function scheduleVersion() {
      clearTimeout(versionTimer);
      versionTimer = setTimeout(() => {
        const doc = getCurrentDoc();
        if (doc && editorBody.innerText.trim()) {
          saveVersion(doc.id, doc.title, doc.body);
        }
      }, VERSION_IDLE);
    }

    editorBody.addEventListener('input', scheduleVersion);
    editorTitle.addEventListener('input', scheduleVersion);

    // ═══════════════════════════════════════════════
    // 6. QUOTE BLOCK ON PASTE
    // ═══════════════════════════════════════════════
    const quoteToast = document.getElementById('quoteToast');
    const quoteToastYes = document.getElementById('quoteToastYes');
    const quoteToastNo = document.getElementById('quoteToastNo');
    let quotePastedRange = null;
    let quoteToastTimer = null;
    let quotePastedText = '';

    function showQuoteToast() {
      quoteToast.classList.add('visible');
      clearTimeout(quoteToastTimer);
      quoteToastTimer = setTimeout(dismissQuoteToast, 4000);
    }

    function dismissQuoteToast() {
      quoteToast.classList.remove('visible');
      quotePastedRange = null;
      quotePastedText = '';
    }

    quoteToastYes.addEventListener('click', () => {
      if (!quotePastedRange) { dismissQuoteToast(); return; }
      // Find the pasted text node and wrap it in a blockquote
      editorBody.focus();
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(quotePastedRange);
      document.execCommand('formatBlock', false, 'blockquote');
      scheduleSave();
      dismissQuoteToast();
    });

    quoteToastNo.addEventListener('click', dismissQuoteToast);

    // Paste handler — plain text only, with quote-on-paste prompt for long pastes
    editorBody.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
      scheduleSave();

      if (text.length > 100) {
        // Capture range of just-pasted text
        const sel = window.getSelection();
        if (sel.rangeCount) {
          quotePastedText = text;
          // The pasted text ends at current cursor; try to select it
          const endRange = sel.getRangeAt(0).cloneRange();
          // We can't reliably get the start, so store end and text for block command
          quotePastedRange = endRange;
          showQuoteToast();
        }
      }
    });

    // Social share listeners (need getCurrentDoc defined above)
    document.getElementById('shareSubstack').addEventListener('click', () => {
      showToast('Opening Substack…');
    });
    document.getElementById('shareTwitter').addEventListener('click', () => {
      const doc = getCurrentDoc();
      const text = encodeURIComponent((doc ? doc.title || 'New note' : 'New note'));
      window.open('https://twitter.com/intent/tweet?text=' + text + '&url=https%3A%2F%2F' + encodeURIComponent(MOCK_SHARE_LINK), '_blank');
    });
    document.getElementById('shareLinkedIn').addEventListener('click', () => {
      window.open('https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2F' + encodeURIComponent(MOCK_SHARE_LINK), '_blank');
    });

    // ——— AI helper ———
    const aiHelperEl    = document.getElementById('aiHelper');
    const aiHelperInput = document.getElementById('aiHelperInput');
    const aiHelperSend  = document.getElementById('aiHelperSend');

    function showAiHelper() {
      aiHelperEl.classList.add('visible');
    }

    function hideAiHelper() {
      aiHelperEl.classList.remove('visible');
      aiHelperInput.value = '';
      aiHelperInput.style.height = '';
    }

    async function openNewNote() {
      // Immediately create blank note — editor appears at once, no modal
      await createDoc('', '<p></p>');
      // Show subtle AI helper at bottom (non-blocking)
      showAiHelper();
    }

    // Auto-resize textarea
    aiHelperInput.addEventListener('input', () => {
      aiHelperInput.style.height = 'auto';
      aiHelperInput.style.height = Math.min(aiHelperInput.scrollHeight, 80) + 'px';
    });

    aiHelperInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        triggerAiHelper();
      } else if (e.key === 'Escape') {
        hideAiHelper();
      }
    });

    aiHelperSend.addEventListener('click', triggerAiHelper);

    async function triggerAiHelper() {
      const topic = aiHelperInput.value.trim();
      if (!topic) { aiHelperInput.focus(); return; }

      aiHelperSend.classList.add('loading');
      aiHelperSend.disabled = true;

      let draft;
      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });
        if (!res.ok) throw new Error('status ' + res.status);
        draft = await res.json();
      } catch (err) {
        console.error('ai helper error:', err);
        showSyncError('Could not generate. Try again.');
        aiHelperSend.classList.remove('loading');
        aiHelperSend.disabled = false;
        return;
      }

      const titleText = (editorTitle.textContent || '').trim();
      const bodyText  = stripHtml(editorBody.innerHTML || '').trim();
      const isEmpty   = !titleText && (!bodyText || bodyText === '');

      if (isEmpty) {
        // Blank document — populate title and body fully
        editorTitle.textContent = draft.title || '';
        editorBody.innerHTML    = draft.body  || '<p></p>';
        const doc = getCurrentDoc();
        if (doc) {
          doc.title = editorTitle.textContent;
          doc.body  = editorBody.innerHTML;
        }
        // Cursor at end of body so user can keep writing
        requestAnimationFrame(() => {
          editorBody.focus();
          const r = document.createRange();
          r.selectNodeContents(editorBody);
          r.collapse(false);
          const sel = window.getSelection();
          if (sel) { sel.removeAllRanges(); sel.addRange(r); }
        });
      } else {
        // Existing content — insert generated text at caret position
        editorBody.focus();
        const sel = window.getSelection();
        let range;
        if (sel && sel.rangeCount > 0 && editorBody.contains(sel.anchorNode)) {
          range = sel.getRangeAt(0);
        } else {
          range = document.createRange();
          range.selectNodeContents(editorBody);
          range.collapse(false);
        }
        range.deleteContents();
        const tmp  = document.createElement('div');
        tmp.innerHTML = draft.body || '';
        const frag = document.createDocumentFragment();
        while (tmp.firstChild) frag.appendChild(tmp.firstChild);
        range.insertNode(frag);
        range.collapse(false);
        if (sel) { sel.removeAllRanges(); sel.addRange(range); }
      }

      // Reset helper input, keep helper visible for follow-up
      aiHelperInput.value = '';
      aiHelperInput.style.height = '';
      aiHelperSend.classList.remove('loading');
      aiHelperSend.disabled = false;

      renderDocList();
      updateWordCount();
      scheduleSave();
    }

    // ═══════════════════════════════════════════════
    // 7. FLOATING FORMAT BAR
    // ═══════════════════════════════════════════════
    const fmtBar       = document.getElementById('fmtBar');
    const fmtLinkPanel = document.getElementById('fmtLinkPanel');
    const fmtLinkInput = document.getElementById('fmtLinkInput');
    const fmtLinkApply = document.getElementById('fmtLinkApply');
    let fmtBarSelRange = null; // stored selection for format commands

    function checkAndShowFmtBar() {
      const sel = window.getSelection();
      if (!sel || sel.isCollapsed || sel.rangeCount === 0) { hideFmtBar(); return; }
      const range = sel.getRangeAt(0);
      if (!editorBody.contains(range.commonAncestorContainer)) { hideFmtBar(); return; }
      if (sel.toString().trim().length === 0) { hideFmtBar(); return; }
      showFmtBar(range);
    }

    function showFmtBar(range) {
      const rect = range.getBoundingClientRect();
      if (!rect || rect.width === 0) return;
      fmtBarSelRange = range.cloneRange();

      const GAP = 8;
      const barH = 38;
      const viewW = window.innerWidth;

      // Center horizontally on selection
      let left = rect.left + rect.width / 2;
      left = Math.max(130, Math.min(left, viewW - 130));

      // Prefer above; fall back to below
      let top = rect.top - barH - GAP;
      if (top < 8) top = rect.bottom + GAP;

      fmtBar.style.left = left + 'px';
      fmtBar.style.top  = top  + 'px';
      fmtBar.classList.add('visible');
      updateFmtBarState();

      // Show the AI Edit Bar on the opposite side of the selection
      showAiEditBar(range, rect);
    }

    function hideFmtBar() {
      fmtBar.classList.remove('visible');
      hideFmtLinkPanel();
      fmtBarSelRange = null;
      hideAiEditBar(); // also dismiss the AI Edit Bar
    }

    function updateFmtBarState() {
      fmtBar.querySelectorAll('[data-cmd]').forEach(btn => {
        const cmd = btn.dataset.cmd;
        if (cmd === 'bold' || cmd === 'italic' || cmd === 'underline') {
          try { btn.classList.toggle('active', document.queryCommandState(cmd)); } catch (_) {}
        }
      });
    }

    function hideFmtLinkPanel() {
      fmtLinkPanel.classList.remove('visible');
      fmtLinkInput.value = '';
    }

    function showFmtLinkPanel() {
      const barRect = fmtBar.getBoundingClientRect();
      fmtLinkPanel.style.left = fmtBar.style.left;
      fmtLinkPanel.style.top  = (barRect.bottom + 6) + 'px';
      fmtLinkPanel.classList.add('visible');
      // Pre-fill if caret is inside a link
      if (fmtBarSelRange) {
        const anchor = fmtBarSelRange.startContainer.parentNode &&
                       fmtBarSelRange.startContainer.parentNode.closest &&
                       fmtBarSelRange.startContainer.parentNode.closest('a');
        if (anchor) fmtLinkInput.value = anchor.href || '';
      }
      setTimeout(() => fmtLinkInput.focus(), 20);
    }

    function applyFmtLink() {
      const url = fmtLinkInput.value.trim();
      hideFmtLinkPanel();
      if (!fmtBarSelRange) return;
      editorBody.focus();
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(fmtBarSelRange);
      if (url) {
        document.execCommand('createLink', false, url);
        // Make link open in new tab
        const anchor = sel.anchorNode && sel.anchorNode.parentNode &&
                       sel.anchorNode.parentNode.closest('a');
        if (anchor) anchor.target = '_blank';
      } else {
        document.execCommand('unlink', false, null);
      }
      hideFmtBar();
      scheduleSave();
    }

    // Format bar button handler — mousedown to preserve selection
    fmtBar.addEventListener('mousedown', (e) => {
      const btn = e.target.closest('[data-cmd]');
      if (!btn) { e.preventDefault(); return; }
      e.preventDefault(); // ← keeps the selection alive
      const cmd = btn.dataset.cmd;

      if (cmd === 'link') {
        // Save current selection before link panel steals focus
        const sel = window.getSelection();
        if (sel && sel.rangeCount) fmtBarSelRange = sel.getRangeAt(0).cloneRange();
        showFmtLinkPanel();
        return;
      }

      if (cmd === 'ai') {
        // Hand off to the AI floating chat
        hideFmtBar();
        // Restore selection so tryOpenChat can read it
        if (fmtBarSelRange) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(fmtBarSelRange);
        }
        tryOpenChat();
        return;
      }

      // Restore selection before executing format command
      if (fmtBarSelRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(fmtBarSelRange);
      }
      document.execCommand(cmd, false, null);
      editorBody.focus();
      hideFmtBar();
      scheduleSave();
      // Format feedback flash (opacity + subtle tint, GPU-only, 280ms)
      const edWrap = editorBody.closest('.editor-wrap') || document.querySelector('.editor-wrap');
      if (edWrap) {
        edWrap.classList.remove('fmt-feedback');
        void edWrap.offsetWidth; // force reflow to restart animation
        edWrap.classList.add('fmt-feedback');
        const onEnd = () => { edWrap.classList.remove('fmt-feedback'); };
        edWrap.addEventListener('animationend', onEnd, { once: true });
      }
    });

    // Link panel handlers
    fmtLinkInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter')  { e.preventDefault(); applyFmtLink(); }
      if (e.key === 'Escape') { hideFmtLinkPanel(); }
    });
    fmtLinkApply.addEventListener('mousedown', (e) => { e.preventDefault(); applyFmtLink(); });
    fmtLinkPanel.addEventListener('mousedown', (e) => e.stopPropagation());

    // Hide fmt bar when selection collapses (typing, clicking elsewhere)
    document.addEventListener('selectionchange', () => {
      if (!fmtBar.classList.contains('visible')) return;
      if (fmtLinkPanel.classList.contains('visible')) return; // keep open for link input
      const sel = window.getSelection();
      if (!sel || sel.isCollapsed || sel.toString().trim().length === 0) hideFmtBar();
    });

    // Escape closes fmt bar
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && fmtBar.classList.contains('visible')) hideFmtBar();
    });

    // Click outside closes fmt bar
    document.addEventListener('mousedown', (e) => {
      if (!fmtBar.contains(e.target) && !fmtLinkPanel.contains(e.target)) hideFmtBar();
    });

    // ═══════════════════════════════════════════════
    // 8. BLOCK HANDLE + DRAG REORDER
    // ═══════════════════════════════════════════════
    const paraHandle    = document.getElementById('paraHandle');
    const blockTypeMenu = document.getElementById('blockTypeMenu');
    const dragInsertLine = document.getElementById('dragInsertLine');
    const dragDeleteZone = document.getElementById('dragDeleteZone');
    let handleBlock    = null; // block currently hovered
    let dragState      = null; // { block, ghost, insertBefore }
    let handleHideTimer = null;

    function getTopBlock(node) {
      while (node && node.parentNode !== editorBody) node = node.parentNode;
      return (node && node !== editorBody) ? node : null;
    }

    function positionHandle(block) {
      const rect = block.getBoundingClientRect();
      paraHandle.style.top  = Math.round(rect.top + rect.height / 2 - 11) + 'px';
      paraHandle.style.left = Math.round(rect.left - 28) + 'px';
      handleBlock = block;
      paraHandle.classList.add('visible');
    }

    function hideHandle() {
      paraHandle.classList.remove('visible');
      handleBlock = null;
    }

    editorBody.addEventListener('mouseover', (e) => {
      if (dragState) return;
      clearTimeout(handleHideTimer);
      const block = getTopBlock(e.target);
      if (block) positionHandle(block);
    });
    editorBody.addEventListener('mouseleave', () => {
      if (dragState) return;
      handleHideTimer = setTimeout(hideHandle, 300);
    });
    paraHandle.addEventListener('mouseenter', () => clearTimeout(handleHideTimer));
    paraHandle.addEventListener('mouseleave', () => {
      if (!blockTypeMenu.classList.contains('visible')) {
        handleHideTimer = setTimeout(hideHandle, 300);
      }
    });

    // Click handle → open block type menu
    paraHandle.addEventListener('click', (e) => {
      if (dragState) return;
      e.stopPropagation();
      if (blockTypeMenu.classList.contains('visible')) {
        blockTypeMenu.classList.remove('visible');
        return;
      }
      const r = paraHandle.getBoundingClientRect();
      blockTypeMenu.style.left = (r.right + 6) + 'px';
      blockTypeMenu.style.top  = r.top + 'px';
      blockTypeMenu.classList.add('visible');
      // Mark current block type active
      const tag = (handleBlock ? handleBlock.tagName : 'P').toLowerCase();
      const normTag = (tag === 'ul' || tag === 'ol') ? tag : tag;
      blockTypeMenu.querySelectorAll('.btype-item').forEach(item => {
        item.classList.toggle('active', item.dataset.btype === normTag);
      });
    });

    // Block type menu → apply
    blockTypeMenu.addEventListener('mousedown', (e) => {
      const item = e.target.closest('.btype-item');
      if (!item || !handleBlock) return;
      e.preventDefault();
      blockTypeMenu.classList.remove('visible');
      editorBody.focus();
      const range = document.createRange();
      range.selectNodeContents(handleBlock);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      const btype = item.dataset.btype;
      if (btype === 'ul')         document.execCommand('insertUnorderedList');
      else if (btype === 'ol')    document.execCommand('insertOrderedList');
      else                        document.execCommand('formatBlock', false, btype);
      scheduleSave();
    });

    document.addEventListener('click', (e) => {
      if (!blockTypeMenu.contains(e.target) && e.target !== paraHandle) {
        blockTypeMenu.classList.remove('visible');
      }
    });

    // ——— Drag reorder ———
    paraHandle.addEventListener('mousedown', (e) => {
      if (e.button !== 0 || !handleBlock) return;
      e.preventDefault();
      e.stopPropagation();
      const block = handleBlock;
      const br    = block.getBoundingClientRect();

      const ghost = document.createElement('div');
      ghost.className = 'drag-ghost';
      ghost.textContent = (block.innerText || '').slice(0, 80) +
                          (block.innerText && block.innerText.length > 80 ? '…' : '');
      ghost.style.width = br.width + 'px';
      ghost.style.top   = e.clientY + 'px';
      ghost.style.left  = br.left + 'px';
      document.body.appendChild(ghost);

      block.classList.add('block-dragging');
      dragDeleteZone.classList.add('visible');
      blockTypeMenu.classList.remove('visible');
      hideHandle();

      dragState = { block, ghost, insertBefore: null };
      document.addEventListener('mousemove', onDragMove, { passive: true });
      document.addEventListener('mouseup',   onDragEnd);
    });

    function onDragMove(e) {
      if (!dragState) return;
      const { ghost, block } = dragState;
      ghost.style.top  = (e.clientY - 14) + 'px';
      ghost.style.left = block.getBoundingClientRect().left + 'px';

      const siblings = [...editorBody.children].filter(b => b !== block);
      let insertBefore = null;
      for (const b of siblings) {
        const r = b.getBoundingClientRect();
        if (e.clientY < r.top + r.height * 0.5) { insertBefore = b; break; }
      }
      dragState.insertBefore = insertBefore;

      if (insertBefore) {
        const r = insertBefore.getBoundingClientRect();
        dragInsertLine.style.top   = (r.top - 1) + 'px';
        dragInsertLine.style.left  = r.left + 'px';
        dragInsertLine.style.width = r.width + 'px';
        dragInsertLine.classList.add('visible');
      } else {
        const last = siblings[siblings.length - 1];
        if (last) {
          const r = last.getBoundingClientRect();
          dragInsertLine.style.top   = (r.bottom + 1) + 'px';
          dragInsertLine.style.left  = r.left + 'px';
          dragInsertLine.style.width = r.width + 'px';
          dragInsertLine.classList.add('visible');
        } else {
          dragInsertLine.classList.remove('visible');
        }
      }

      const dz = dragDeleteZone.getBoundingClientRect();
      dragDeleteZone.classList.toggle('active', e.clientY > dz.top);
    }

    function onDragEnd(e) {
      if (!dragState) return;
      const { block, ghost, insertBefore } = dragState;
      ghost.remove();
      block.classList.remove('block-dragging');
      dragInsertLine.classList.remove('visible');
      dragDeleteZone.classList.remove('visible', 'active');
      dragState = null;
      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup',   onDragEnd);

      const dz = dragDeleteZone.getBoundingClientRect();
      if (e.clientY > dz.top - 56) {
        block.remove();
      } else if (insertBefore) {
        editorBody.insertBefore(block, insertBefore);
      } else {
        editorBody.appendChild(block);
      }
      renderDocList();
      updateWordCount();
      scheduleSave();
    }

    // ═══════════════════════════════════════════════
    // 9. EDITOR KEYBOARD SHORTCUTS
    // ═══════════════════════════════════════════════
    editorBody.addEventListener('keydown', (e) => {
      const mod = e.metaKey || e.ctrlKey;

      // Tab / Shift+Tab → indent / outdent (lists)
      if (e.key === 'Tab') {
        e.preventDefault();
        document.execCommand(e.shiftKey ? 'outdent' : 'indent');
        scheduleSave();
        return;
      }

      // Cmd/Ctrl+K → Insert or edit link
      if (mod && e.key === 'k') {
        e.preventDefault();
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed && sel.rangeCount > 0 &&
            editorBody.contains(sel.anchorNode)) {
          const range = sel.getRangeAt(0).cloneRange();
          showFmtBar(range);
          showFmtLinkPanel();
        }
        return;
      }

      // Cmd/Ctrl+B/I/U — let browser handle natively but also close fmt bar + flash
      if (mod && (e.key === 'b' || e.key === 'i' || e.key === 'u')) {
        hideFmtBar();
        // browser default executes bold/italic/underline
        requestAnimationFrame(() => {
          const edWrap = document.querySelector('.editor-wrap');
          if (edWrap) {
            edWrap.classList.remove('fmt-feedback');
            void edWrap.offsetWidth;
            edWrap.classList.add('fmt-feedback');
            edWrap.addEventListener('animationend', () => edWrap.classList.remove('fmt-feedback'), { once: true });
          }
        });
      }

      // Backspace/Delete when whole block is selected via handle
      if ((e.key === 'Backspace' || e.key === 'Delete') && handleBlock) {
        const sel = window.getSelection();
        if (!sel || !sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        if (!range.collapsed && range.toString() === (handleBlock.innerText || '')) {
          e.preventDefault();
          handleBlock.remove();
          hideHandle();
          scheduleSave();
        }
      }
    });

    // ——— Global keyboard shortcuts ———
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault();
        openNewNote();
      } else if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        e.preventDefault();
        const si = document.getElementById('searchInput');
        si.focus();
        si.select();
      }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // AI EDIT BAR  — selection quick actions + alternatives panel
    // ═══════════════════════════════════════════════════════════════════════
    (function () {

      // ── Element refs ──────────────────────────────────────────────────────
      const aiEditBar       = document.getElementById('aiEditBar');
      const aiEditResults   = document.getElementById('aiEditResults');
      const aiEditLoadingRow= document.getElementById('aiEditLoadingRow');
      const aiEditAltsList  = document.getElementById('aiEditAltsList');
      const aiEditErrorRow  = document.getElementById('aiEditErrorRow');
      const aiEditErrorMsg  = document.getElementById('aiEditErrorMsg');
      const aiEditRetryBtn  = document.getElementById('aiEditRetryBtn');
      const aiEditFooter    = document.getElementById('aiEditFooter');
      const aiEditToneWrap  = document.getElementById('aiEditToneWrap');
      const aiEditToneBtn   = document.getElementById('aiEditToneBtn');
      const aiEditToneDd    = document.getElementById('aiEditToneDropdown');
      const aiEditMoreWrap  = document.getElementById('aiEditMoreWrap');
      const aiEditMoreBtn   = document.getElementById('aiEditMoreBtn');
      const aiEditMoreDd    = document.getElementById('aiEditMoreDropdown');
      const aiEditClose     = document.getElementById('aiEditClose');
      const aiEditApplyRepl = document.getElementById('aiEditApplyReplace');
      const aiEditApplyIns  = document.getElementById('aiEditApplyInsert');
      const aiEditApplyCncl = document.getElementById('aiEditApplyCancel');

      // ── State ─────────────────────────────────────────────────────────────
      let selRange    = null;   // cloned Range saved at bar-show time
      let selText     = '';     // plain-text backup (survives if Range is GC'd)
      let alts        = [];     // current alternatives array
      let selectedIdx = 0;      // which card is selected
      let lastAction  = null;   // for retry
      let lastTone    = null;

      // ── Prevent clicks on bar/panel from clearing the editor selection ───
      // e.preventDefault()  → prevents editor blur (keeps selection alive)
      // e.stopPropagation() → prevents document-level mousedown from calling
      //                        hideFmtBar → hideAiEditBar before click fires,
      //                        which would null selRange and silence the click.
      aiEditBar.addEventListener('mousedown',     e => { e.preventDefault(); e.stopPropagation(); });
      aiEditResults.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });

      // ── Public: called by showFmtBar ──────────────────────────────────────
      // Exposed on window so showFmtBar (defined above) can call it.
      window.showAiEditBar = function showAiEditBar(range, selRect) {
        selRange = range.cloneRange();
        selText  = range.toString();

        // Position: below selection (or above if near bottom)
        const rect  = selRect || range.getBoundingClientRect();
        const GAP   = 8;
        const barH  = 36;
        const viewW = window.innerWidth;
        const viewH = window.innerHeight;

        let left = rect.left + rect.width / 2;
        left = Math.max(185, Math.min(left, viewW - 185));

        let top = rect.bottom + GAP;
        // If the fmt-bar ended up below (rect.top - barH - 8 < 8), we also put
        // the AI bar below — just add extra gap so they don't overlap.
        const fmtIsAbove = (rect.top - barH - 8) >= 8;
        if (!fmtIsAbove) {
          // fmt-bar is BELOW → put AI bar further below (+44px for fmt-bar height)
          top = rect.bottom + GAP + 44;
        }
        if (top + barH > viewH - 8) {
          // Not enough room below → go above selection
          top = rect.top - barH - GAP;
        }

        aiEditBar.style.left = left + 'px';
        aiEditBar.style.top  = top + 'px';
        aiEditBar._anchorLeft = left;
        aiEditBar._anchorBottom = top + barH;
        aiEditBar._selRect = rect;
        aiEditBar.classList.add('visible');
      };

      // ── Public: called by hideFmtBar ──────────────────────────────────────
      window.hideAiEditBar = function hideAiEditBar() {
        aiEditBar.classList.remove('visible');
        aiEditResults.classList.remove('visible');
        closeDropdowns();
        selRange    = null;
        selText     = '';
        alts        = [];
        lastAction  = null;
        lastTone    = null;
      };

      // ── Dropdown helpers ──────────────────────────────────────────────────
      function closeDropdowns() {
        aiEditToneDd.classList.remove('open');
        aiEditMoreDd.classList.remove('open');
        aiEditToneBtn.setAttribute('aria-expanded', 'false');
        aiEditMoreBtn.setAttribute('aria-expanded', 'false');
      }

      function toggleDropdown(dd, triggerBtn) {
        const isOpen = dd.classList.contains('open');
        closeDropdowns();
        if (!isOpen) {
          dd.classList.add('open');
          triggerBtn.setAttribute('aria-expanded', 'true');
        }
      }

      // ── Close button ──────────────────────────────────────────────────────
      aiEditClose.addEventListener('click', window.hideAiEditBar);

      // ── Quick action buttons ───────────────────────────────────────────────
      aiEditBar.querySelectorAll('[data-edit-action]').forEach(btn => {
        btn.addEventListener('click', () =>
          triggerAction(btn.dataset.editAction, null, btn)
        );
      });

      // ── Tone dropdown ──────────────────────────────────────────────────────
      aiEditToneBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleDropdown(aiEditToneDd, aiEditToneBtn);
      });
      aiEditToneDd.querySelectorAll('[data-tone]').forEach(item => {
        item.addEventListener('click', () => {
          closeDropdowns();
          triggerAction('tone', item.dataset.tone, aiEditToneBtn);
        });
      });

      // ── More dropdown ──────────────────────────────────────────────────────
      aiEditMoreBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleDropdown(aiEditMoreDd, aiEditMoreBtn);
      });
      aiEditMoreDd.querySelectorAll('[data-edit-action]').forEach(item => {
        item.addEventListener('click', () => {
          closeDropdowns();
          triggerAction(item.dataset.editAction, null, aiEditMoreBtn);
        });
      });

      // ── Close dropdowns on outside click ──────────────────────────────────
      document.addEventListener('click', e => {
        if (!aiEditToneWrap.contains(e.target)) aiEditToneDd.classList.remove('open');
        if (!aiEditMoreWrap.contains(e.target)) aiEditMoreDd.classList.remove('open');
      });

      // ── ESC to close ──────────────────────────────────────────────────────
      document.addEventListener('keydown', e => {
        if (e.key !== 'Escape') return;
        if (aiEditResults.classList.contains('visible')) {
          aiEditResults.classList.remove('visible');
        } else if (aiEditBar.classList.contains('visible')) {
          window.hideAiEditBar();
        }
      });

      // ── Retry ─────────────────────────────────────────────────────────────
      aiEditRetryBtn.addEventListener('click', () => {
        if (lastAction) triggerAction(lastAction, lastTone, null);
      });

      // ── Apply / Cancel ─────────────────────────────────────────────────────
      aiEditApplyRepl.addEventListener('click', () => applyEdit('replace'));
      aiEditApplyIns.addEventListener('click',  () => applyEdit('insertBelow'));
      aiEditApplyCncl.addEventListener('click', window.hideAiEditBar);

      // ── Core: trigger an edit action ──────────────────────────────────────
      async function triggerAction(action, tone, triggerBtn) {
        // DEV LOG — fires immediately on click; if you don't see this, the
        // event handler is not attached or blocked by an overlay.
        console.log('[AI_EDIT] click', action, tone || '');

        // Resolve selected text: prefer live Range, fall back to saved plain-text
        const resolvedText = (selRange ? selRange.toString() : selText).trim();
        if (!resolvedText) {
          console.warn('[AI_EDIT] no selection text — bar may have been closed before click');
          return;
        }

        lastAction = action;
        lastTone   = tone;

        // Reset results panel to loading state
        aiEditLoadingRow.classList.add('on');
        aiEditAltsList.classList.remove('on');
        aiEditAltsList.innerHTML = '';
        aiEditErrorRow.classList.remove('on');
        aiEditFooter.classList.remove('on');

        // Position and show results panel
        positionResults();
        aiEditResults.classList.add('visible');

        // Pulse the trigger button while loading
        if (triggerBtn) triggerBtn.classList.add('loading');

        try {
          const data = await fetchAlts(action, tone, resolvedText);

          if (data.error || !data.alternatives || !data.alternatives.length) {
            showError(data.error === 'parse_failed'
              ? 'AI returned unexpected format. Try again.'
              : 'Couldn\'t generate alternatives. Try again.');
            return;
          }

          renderAlts(data.alternatives);
          // Re-position now that content height is known
          positionResults();

        } catch (err) {
          console.error('[AI_EDIT] error', err);
          showError('Generation failed. Check your connection.');
        } finally {
          aiEditLoadingRow.classList.remove('on');
          if (triggerBtn) triggerBtn.classList.remove('loading');
        }
      }

      // ── Fetch via Supabase Edge Function (full note context) ──────────────
      // Calls: POST https://<project>.supabase.co/functions/v1/ai-edit
      // Uses sbClient.functions.invoke so auth token + apikey are set automatically.
      async function fetchAlts(action, tone, selectedText) {
        // ── 1. Gather current note ────────────────────────────────────────
        const doc       = (typeof getCurrentDoc === 'function') ? getCurrentDoc() : null;
        const noteTitle = doc ? (doc.title || '') : '';

        // Strip HTML → plain text so the model sees clean prose
        const noteContent = (() => {
          if (!doc || !doc.body) return '';
          const tmp = document.createElement('div');
          tmp.innerHTML = doc.body;
          return (tmp.innerText || tmp.textContent || '').replace(/\n{3,}/g, '\n\n').trim();
        })();

        // ── 2. Surrounding context (up to 800 chars before/after selection) ─
        let before = '', after = '';
        try {
          const bodyEl   = document.getElementById('editorBody');
          const fullText = bodyEl ? (bodyEl.innerText || '') : '';
          const idx      = fullText.indexOf(selectedText);
          if (idx >= 0) {
            before = fullText.slice(Math.max(0, idx - 800), idx);
            after  = fullText.slice(idx + selectedText.length,
                                    idx + selectedText.length + 800);
          }
        } catch (_) { /* non-fatal */ }

        // ── 3. Build payload (flat — matches edge function contract) ──────
        const payload = {
          action,
          tone:         tone || null,
          noteTitle,
          noteContent,
          selectedText,
          before,
          after,
          languageHint: null,   // server keeps source language automatically
        };
        console.log('[AI_EDIT] request:start', payload);

        // ── 4. Call Supabase Edge Function ────────────────────────────────
        // sbClient.functions.invoke automatically adds:
        //   apikey: <SB_KEY>
        //   authorization: Bearer <session access_token>
        if (!sbClient) throw new Error('Supabase client not initialised');

        const { data, error } = await sbClient.functions.invoke('ai-edit', {
          body: payload,
        });

        console.log('[AI_EDIT] request:done', error ? ('error: ' + error.message) : 200);

        if (error) {
          console.error('[AI_EDIT] error', error);
          throw new Error(error.message || 'Edge function error');
        }
        return data;
      }

      // ── Show error state ──────────────────────────────────────────────────
      function showError(msg) {
        aiEditLoadingRow.classList.remove('on');
        aiEditAltsList.classList.remove('on');
        aiEditFooter.classList.remove('on');
        aiEditErrorMsg.textContent = msg;
        aiEditErrorRow.classList.add('on');
      }

      // ── Render alternatives ────────────────────────────────────────────────
      function renderAlts(alternatives) {
        alts = alternatives;
        selectedIdx = 0;
        aiEditAltsList.innerHTML = '';

        alternatives.forEach((alt, i) => {
          const row = document.createElement('div');
          row.className = 'ai-edit-alt-row' + (i === 0 ? ' sel' : '');
          row.setAttribute('role', 'option');
          row.setAttribute('aria-selected', i === 0 ? 'true' : 'false');

          const isLong = alt.text.length > 180;
          row.innerHTML =
            '<span class="ai-edit-alt-dot"></span>' +
            '<div class="ai-edit-alt-body">' +
              '<div class="ai-edit-alt-tag">' + escapeHtml(alt.label) + '</div>' +
              '<div class="ai-edit-alt-text">' + escapeHtml(alt.text) + '</div>' +
              (isLong ? '<button type="button" class="ai-edit-alt-expand show">Show more</button>' : '') +
            '</div>';

          // Expand toggle
          const expandBtn = row.querySelector('.ai-edit-alt-expand');
          if (expandBtn) {
            expandBtn.addEventListener('click', e => {
              e.stopPropagation();
              row.classList.toggle('expanded');
              expandBtn.textContent = row.classList.contains('expanded') ? 'Show less' : 'Show more';
            });
          }

          // Select on click
          row.addEventListener('click', () => selectAlt(i));

          aiEditAltsList.appendChild(row);
        });

        aiEditAltsList.classList.add('on');
        aiEditFooter.classList.add('on');
        aiEditErrorRow.classList.remove('on');
      }

      // ── Select an alternative card ─────────────────────────────────────────
      function selectAlt(idx) {
        selectedIdx = idx;
        aiEditAltsList.querySelectorAll('.ai-edit-alt-row').forEach((row, i) => {
          row.classList.toggle('sel', i === idx);
          row.setAttribute('aria-selected', i === idx ? 'true' : 'false');
        });
      }

      // ── Position results panel below the bar ───────────────────────────────
      function positionResults() {
        const barRect = aiEditBar.getBoundingClientRect();
        const viewW   = window.innerWidth;
        const viewH   = window.innerHeight;
        const GAP     = 6;
        const panelW  = 370;

        // Same center X as the bar
        let left = parseFloat(aiEditBar.style.left);
        left = Math.max(16 + panelW / 2, Math.min(left, viewW - 16 - panelW / 2));
        aiEditResults.style.left = left + 'px';

        // Below bar; shift above if near bottom
        let top = barRect.bottom + GAP;
        if (top + 260 > viewH - 12) {
          const selRect = aiEditBar._selRect || {};
          top = Math.max(12, (selRect.top || barRect.top) - 260 - GAP);
        }
        aiEditResults.style.top = top + 'px';
      }

      // ── Apply edit to the document ─────────────────────────────────────────
      function applyEdit(mode) {
        const alt = alts[selectedIdx];
        if (!alt || !selRange) return;

        const text = alt.text;
        const sel  = window.getSelection();

        if (mode === 'replace') {
          // Restore the saved selection, then insertText for proper undo
          sel.removeAllRanges();
          sel.addRange(selRange);
          document.execCommand('insertText', false, text);

        } else if (mode === 'insertBelow') {
          // Walk up to find the nearest block ancestor
          let node = selRange.endContainer;
          const BLOCKS = ['P','DIV','H1','H2','H3','H4','H5','H6','LI','BLOCKQUOTE'];
          let blockEl = null;
          while (node && node !== editorBody) {
            if (BLOCKS.includes(node.nodeName)) { blockEl = node; break; }
            node = node.parentNode;
          }

          if (blockEl) {
            // Move caret just after the block, then insert a new paragraph
            const r = document.createRange();
            r.setStartAfter(blockEl);
            r.collapse(true);
            sel.removeAllRanges();
            sel.addRange(r);
            // Use insertHTML so we get a proper <p> and undo stays single-step
            const safeHtml = '<p>' + escapeHtml(text) + '</p>';
            document.execCommand('insertHTML', false, safeHtml);
          } else {
            // Fallback: plain text after the selection
            const r = selRange.cloneRange();
            r.collapse(false);
            sel.removeAllRanges();
            sel.addRange(r);
            document.execCommand('insertText', false, '\n' + text);
          }
        }

        window.hideAiEditBar();
        if (typeof scheduleSave === 'function') scheduleSave();
      }

    })(); // end AI Edit Bar IIFE

    // ——— Theme management ———
    (function () {
      const THEME_KEY = 'pages-theme';

      function applyTheme(theme, animate) {
        if (animate) {
          document.body.classList.add('theme-transition');
          window.setTimeout(function() {
            document.body.classList.remove('theme-transition');
          }, 130);
        }
        if (theme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      }

      function getCurrentTheme() {
        return document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      }

      // Respect system preference changes (only when user hasn't manually overridden)
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        if (!localStorage.getItem(THEME_KEY)) {
          applyTheme(e.matches ? 'dark' : 'light', true);
        }
      });

      // Theme pill toggle (top-right corner)
      var themePill = document.getElementById('themePill');
      if (themePill) {
        themePill.addEventListener('click', function() {
          var newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
          applyTheme(newTheme, true);
          localStorage.setItem(THEME_KEY, newTheme);
        });
      }
    })();

    // ——— User profile widget ———
    const userWidgetEl   = document.getElementById('userWidget');
    const btnUserProfile = document.getElementById('btnUserProfile');
    const userAvatarEl   = document.getElementById('userAvatar');
    const userNameTextEl = document.getElementById('userNameText');
    const userPopoverEl  = document.getElementById('userPopover');
    const userEmailEl    = document.getElementById('userPopoverEmail');
    const sidebarEmailEl = document.getElementById('sidebarEmail');
    const btnLogout      = document.getElementById('btnLogout');

    // Palette for initials avatars (same hue across light/dark)
    const AVATAR_COLORS = ['#5B7FE0','#7B68C8','#5BA08A','#C97A4A','#B05B7A','#4A91B0','#7A9B5B'];
    function avatarColor(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) & 0xFFFFFF;
      return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
    }

    // Paint the sidebar profile widget.
    // Eagerly renders from auth metadata, then upgrades with data from
    // public.profiles (which may have a richer full_name / avatar_url).
    async function renderUserProfile(user) {
      if (!user) return;
      const meta = user.user_metadata || {};

      // ── 1. Render immediately from auth metadata (fast path) ──
      let displayName = meta.full_name || meta.name || user.email || 'Account';
      let email       = user.email || '';
      let avatarUrl   = meta.avatar_url || null;

      applyProfileUI(displayName, email, avatarUrl);

      // ── 2. Upgrade from public.profiles (accurate after migration) ──
      try {
        const rows = await sbFetch(
          '/rest/v1/profiles?id=eq.' + encodeURIComponent(user.id) +
          '&select=email,full_name,avatar_url&limit=1'
        );
        if (rows && rows.length > 0) {
          const p = rows[0];
          // Only override if the profile has richer data
          if (p.full_name) displayName = p.full_name;
          if (p.email)     email       = p.email;
          if (p.avatar_url) avatarUrl  = p.avatar_url;
          applyProfileUI(displayName, email, avatarUrl);
        }
      } catch (e) {
        // public.profiles might not exist yet (pre-migration) — silently ignore
      }
    }

    function applyProfileUI(displayName, email, avatarUrl) {
      userNameTextEl.textContent = displayName;
      if (userEmailEl) userEmailEl.textContent = email;
      if (sidebarEmailEl) sidebarEmailEl.textContent = email;

      if (avatarUrl) {
        const img = document.createElement('img');
        img.src = avatarUrl;
        img.alt = displayName;
        img.onerror = () => { img.remove(); setInitialsAvatar(displayName); };
        userAvatarEl.textContent = '';
        userAvatarEl.appendChild(img);
      } else {
        setInitialsAvatar(displayName);
      }
    }

    function setInitialsAvatar(name) {
      const parts = name.trim().split(/\s+/);
      const initials = parts.length >= 2
        ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
        : name.slice(0, 2).toUpperCase();
      userAvatarEl.textContent = initials;
      userAvatarEl.style.background = avatarColor(name.toLowerCase());
    }

    // Toggle popover
    if (btnUserProfile) {
      btnUserProfile.addEventListener('click', (e) => {
        e.stopPropagation();
        userPopoverEl.classList.toggle('open');
      });
    }

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (userPopoverEl && userPopoverEl.classList.contains('open') &&
          !userWidgetEl.contains(e.target)) {
        userPopoverEl.classList.remove('open');
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && userPopoverEl && userPopoverEl.classList.contains('open')) {
        userPopoverEl.classList.remove('open');
        btnUserProfile.focus();
      }
    });

    // Logout
    if (btnLogout) {
      btnLogout.addEventListener('click', async () => {
        userPopoverEl.classList.remove('open');
        try {
          if (sbClient) await sbClient.auth.signOut();
        } catch (err) {
          console.error('signOut error:', err);
        } finally {
          window.location.replace('./login.html');
        }
      });
    }

    // ——— Auth guard + init ———
    (async function initApp() {
      updateEmptyState();
      updateWordCount();

      if (!sbClient) {
        // SDK not available — run without auth guard (dev fallback)
        console.warn('Supabase SDK not loaded; skipping auth guard.');
        loadDocuments();
        return;
      }

      try {
        const { data: { session } } = await sbClient.auth.getSession();
        if (!session) {
          window.location.replace('./login.html');
          return;
        }

        // Update REST Authorization header to use the user's JWT
        // (RLS on the server will scope all queries to this user automatically)
        SB_HEADERS['Authorization'] = 'Bearer ' + session.access_token;

        // Store uid so createDoc can include user_id in the INSERT body
        currentUserId = session.user.id;

        // Render the sidebar user profile widget (async — upgrades from profiles table)
        renderUserProfile(session.user); // fire-and-forget; UI updates in two passes

        // Listen for auth state changes (token refresh, sign-out)
        sbClient.auth.onAuthStateChange((event, newSession) => {
          if (!newSession) {
            currentUserId = null;
            window.location.replace('./login.html');
          } else if (newSession.access_token) {
            SB_HEADERS['Authorization'] = 'Bearer ' + newSession.access_token;
            currentUserId = newSession.user.id;
          }
        });

        // Load documents now that auth is confirmed (RLS filters to current user)
        loadDocuments();
      } catch (err) {
        console.error('Auth init error:', err);
        // On error, still try to load (degrade gracefully)
        loadDocuments();
      }
    })();
  </script>
</body>
</html>
